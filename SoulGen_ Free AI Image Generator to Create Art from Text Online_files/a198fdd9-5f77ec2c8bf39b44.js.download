"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1627],{15276:function(T,A,b){b.d(A,{IO:function(){return eo},N8:function(){return es},R:function(){return en},U2:function(){return eh},VF:function(){return ef},iH:function(){return ed},t8:function(){return eg}});var B,h,C,a,i,j,D,k,c=b(25816),E=b(8463),l=b(74444),F=b(53333),U=b(83454);let m="@firebase/database",n="0.13.5",G="";class V{constructor(a){this.domStorage_=a,this.prefix_="firebase:"}set(a,b){null==b?this.domStorage_.removeItem(this.prefixedName_(a)):this.domStorage_.setItem(this.prefixedName_(a),(0,l.Pz)(b))}get(b){let a=this.domStorage_.getItem(this.prefixedName_(b));return null==a?null:(0,l.cI)(a)}remove(a){this.domStorage_.removeItem(this.prefixedName_(a))}prefixedName_(a){return this.prefix_+a}toString(){return this.domStorage_.toString()}}
class W{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(a,b){null==b?delete this.cache_[a]:this.cache_[a]=b}get(a){return(0,l.r3)(this.cache_,a)?this.cache_[a]:null}remove(a){delete this.cache_[a]}}
let o=function(b){try{if("undefined"!=typeof window&&void 0!==window[b]){let a=window[b];return a.setItem("firebase:sentinel","cache"),a.removeItem("firebase:sentinel"),new V(a)}}catch(c){}return new W},X=o("localStorage"),Y=o("sessionStorage"),Z=new F.Yd("@firebase/database"),H,$=(H=1,function(){return H++}),_=function(b){let c=(0,l.dS)(b),a=new l.gQ;a.update(c);let d=a.digest();return l.US.encodeByteArray(d)},aa=function(...d){let b="";for(let c=0;c<d.length;c++){let a=d[c];Array.isArray(a)||a&&"object"==typeof a&&"number"==typeof a.length?b+=aa.apply(null,a):"object"==typeof a?b+=(0,l.Pz)(a):b+=a,b+=" "}return b},ab=null,ac=!0,ad=function(a,b){(0,l.hu)(!b||!0===a||!1===a,"Can't turn on custom loggers persistently."),!0===a?(Z.logLevel=F.in.VERBOSE,ab=Z.log.bind(Z),b&&Y.set("logging_enabled",!0)):"function"==typeof a?ab=a:(ab=null,Y.remove("logging_enabled"))},ae=function(...a){if(!0===ac&&(ac=!1,null===ab&&!0===Y.get("logging_enabled")&&ad(!0)),ab){let b=aa.apply(null,a);ab(b)}},af=function(a){return function(...b){ae(a,...b)}},ag=function(...a){let b="FIREBASE INTERNAL ERROR: "+aa(...a);Z.error(b)},ah=function(...b){let a=`FIREBASE FATAL ERROR: ${aa(...b)}`;throw Z.error(a),Error(a)},ai=function(...a){let b="FIREBASE WARNING: "+aa(...a);Z.warn(b)},aj=function(){"undefined"!=typeof window&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&ai("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().")},ak=function(a){return"number"==typeof a&&(a!=a||a===Number.POSITIVE_INFINITY||a===Number.NEGATIVE_INFINITY)},al=function(b){if((0,l.Yr)()||"complete"===document.readyState)b();else{let c=!1,a=function(){if(!document.body){setTimeout(a,Math.floor(10));return}c||(c=!0,b())};document.addEventListener?(document.addEventListener("DOMContentLoaded",a,!1),window.addEventListener("load",a,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{"complete"===document.readyState&&a()}),window.attachEvent("onload",a))}},I="[MIN_NAME]",J="[MAX_NAME]",am=function(a,b){if(a===b)return 0;if(a===I||b===J)return-1;if(b===I||a===J)return 1;{let d=at(a),c=at(b);return null!==d?null!==c?d-c==0?a.length-b.length:d-c:-1:null!==c?1:a<b?-1:1}},an=function(b,a){if(a&&b in a)return a[b];throw Error("Missing required key ("+b+") in object: "+(0,l.Pz)(a))},ao=function(a){if("object"!=typeof a||null===a)return(0,l.Pz)(a);let b=[];for(let e in a)b.push(e);b.sort();let c="{";for(let d=0;d<b.length;d++)0!==d&&(c+=","),c+=(0,l.Pz)(b[d]),c+=":",c+=ao(a[b[d]]);return c+"}"},ap=function(b,c){let d=b.length;if(d<=c)return[b];let e=[];for(let a=0;a<d;a+=c)a+c>d?e.push(b.substring(a,d)):e.push(b.substring(a,a+c));return e};function aq(a,c){for(let b in a)a.hasOwnProperty(b)&&c(b,a[b])}let ar=function(a){(0,l.hu)(!ak(a),"Invalid JSON number");let g,c,d,h,b;0===a?(c=0,d=0,g=1/a==-1/0?1:0):(g=a<0,a=Math.abs(a),a>=22250738585072014e-324?(c=(h=Math.min(Math.floor(Math.log(a)/Math.LN2),1023))+1023,d=Math.round(a*Math.pow(2,52-h)-4503599627370496)):(c=0,d=Math.round(a/5e-324)));let e=[];for(b=52;b;b-=1)e.push(d%2?1:0),d=Math.floor(d/2);for(b=11;b;b-=1)e.push(c%2?1:0),c=Math.floor(c/2);e.push(g?1:0),e.reverse();let j=e.join(""),i="";for(b=0;b<64;b+=8){let f=parseInt(j.substr(b,8),2).toString(16);1===f.length&&(f="0"+f),i+=f}return i.toLowerCase()},as=RegExp("^-?(0*)\\d{1,10}$"),at=function(b){if(as.test(b)){let a=Number(b);if(a>=-2147483648&&a<=2147483647)return a}return null},au=function(a){try{a()}catch(b){setTimeout(()=>{let a=b.stack||"";throw ai("Exception was thrown by user callback.",a),b},Math.floor(0))}},av=function(){let a="object"==typeof window&&window.navigator&&window.navigator.userAgent||"";return a.search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0},aw=function(b,c){let a=setTimeout(b,c);return"object"==typeof a&&a.unref&&a.unref(),a};class ax{constructor(b,a){this.appName_=b,this.appCheckProvider=a,this.appCheck=null==a?void 0:a.getImmediate({optional:!0}),this.appCheck||null==a||a.get().then(a=>this.appCheck=a)}getToken(a){return this.appCheck?this.appCheck.getToken(a):new Promise((b,c)=>{setTimeout(()=>{this.appCheck?this.getToken(a).then(b,c):b(null)},0)})}addTokenChangeListener(b){var a;null===(a=this.appCheckProvider)||void 0===a||a.get().then(a=>a.addTokenListener(b))}notifyForInvalidToken(){ai(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}}
class ay{constructor(b,c,a){this.appName_=b,this.firebaseOptions_=c,this.authProvider_=a,this.auth_=null,this.auth_=a.getImmediate({optional:!0}),this.auth_||a.onInit(a=>this.auth_=a)}getToken(a){return this.auth_?this.auth_.getToken(a).catch(a=>a&&"auth/token-not-initialized"===a.code?(ae("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(a)):new Promise((b,c)=>{setTimeout(()=>{this.auth_?this.getToken(a).then(b,c):b(null)},0)})}addTokenChangeListener(a){this.auth_?this.auth_.addAuthTokenListener(a):this.authProvider_.get().then(b=>b.addAuthTokenListener(a))}removeTokenChangeListener(a){this.authProvider_.get().then(b=>b.removeAuthTokenListener(a))}notifyForInvalidToken(){let a='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?a+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?a+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':a+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',ai(a)}}class K{constructor(a){this.accessToken=a}getToken(a){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(a){a(this.accessToken)}removeTokenChangeListener(a){}notifyForInvalidToken(){}}K.OWNER="owner";let az=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,aA="websocket",aB="long_polling";class aC{constructor(a,b,c,d,e=!1,f="",g=!1){this.secure=b,this.namespace=c,this.webSocketOnly=d,this.nodeAdmin=e,this.persistenceKey=f,this.includeNamespaceInQueryParams=g,this._host=a.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=X.get("host:"+a)||this._host}isCacheableHost(){return"s-"===this.internalHost.substr(0,2)}isCustomHost(){return"firebaseio.com"!==this._domain&&"firebaseio-demo.com"!==this._domain}get host(){return this._host}set host(a){a!==this.internalHost&&(this.internalHost=a,this.isCacheableHost()&&X.set("host:"+this._host,this.internalHost))}toString(){let a=this.toURLString();return this.persistenceKey&&(a+="<"+this.persistenceKey+">"),a}toURLString(){let a=this.secure?"https://":"http://",b=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${a}${this.host}/${b}`}}function aD(a,b,d){var c;(0,l.hu)("string"==typeof b,"typeof type must == string"),(0,l.hu)("object"==typeof d,"typeof params must == object");let e;if(b===aA)e=(a.secure?"wss://":"ws://")+a.internalHost+"/.ws?";else if(b===aB)e=(a.secure?"https://":"http://")+a.internalHost+"/.lp?";else throw Error("Unknown connection type: "+b);((c=a).host!==c.internalHost||c.isCustomHost()||c.includeNamespaceInQueryParams)&&(d.ns=a.namespace);let f=[];return aq(d,(a,b)=>{f.push(a+"="+b)}),e+f.join("&")}
class aE{constructor(){this.counters_={}}incrementCounter(a,b=1){(0,l.r3)(this.counters_,a)||(this.counters_[a]=0),this.counters_[a]+=b}get(){return(0,l.p$)(this.counters_)}}
let aF={},aG={};function aH(b){let a=b.toString();return aF[a]||(aF[a]=new aE),aF[a]}
class aI{constructor(a){this.onMessage_=a,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(a,b){this.closeAfterResponse=a,this.onClose=b,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(c,d){for(this.pendingResponses[c]=d;this.pendingResponses[this.currentResponseNum];){let b=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let a=0;a<b.length;++a)b[a]&&au(()=>{this.onMessage_(b[a])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}
let aJ="start",aK=1840;class aL{constructor(a,b,c,d,e,f,g){this.connId=a,this.repoInfo=b,this.applicationId=c,this.appCheckToken=d,this.authToken=e,this.transportSessionId=f,this.lastSessionId=g,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=af(a),this.stats_=aH(b),this.urlFn=a=>(this.appCheckToken&&(a.ac=this.appCheckToken),aD(b,aB,a))}open(a,b){this.curSegmentNum=0,this.onDisconnect_=b,this.myPacketOrderer=new aI(a),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(3e4)),al(()=>{if(this.isClosed_)return;this.scriptTagHolder=new aM((...c)=>{let[a,b,d,e,f]=c;if(this.incrementIncomingBytes_(c),this.scriptTagHolder){if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,a===aJ)this.id=b,this.password=d;else if("close"===a)b?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(b,()=>{this.onClosed_()})):this.onClosed_();else throw Error("Unrecognized command received: "+a)}},(...a)=>{let[b,c]=a;this.incrementIncomingBytes_(a),this.myPacketOrderer.handleResponse(b,c)},()=>{this.onClosed_()},this.urlFn);let a={};a[aJ]="t",a.ser=Math.floor(1e8*Math.random()),this.scriptTagHolder.uniqueCallbackIdentifier&&(a.cb=this.scriptTagHolder.uniqueCallbackIdentifier),a.v="5",this.transportSessionId&&(a.s=this.transportSessionId),this.lastSessionId&&(a.ls=this.lastSessionId),this.applicationId&&(a.p=this.applicationId),this.appCheckToken&&(a.ac=this.appCheckToken),"undefined"!=typeof location&&location.hostname&&az.test(location.hostname)&&(a.r="f");let b=this.urlFn(a);this.log_("Connecting via long-poll to "+b),this.scriptTagHolder.addTag(b,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){aL.forceAllow_=!0}static forceDisallow(){aL.forceDisallow_=!0}static isAvailable(){return!(0,l.Yr)()&&(!!aL.forceAllow_||!aL.forceDisallow_&&"undefined"!=typeof document&&null!=document.createElement&&!("object"==typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href))&&!("object"==typeof Windows&&"object"==typeof Windows.UI))}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){!this.isClosed_&&(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(d){let a=(0,l.Pz)(d);this.bytesSent+=a.length,this.stats_.incrementCounter("bytes_sent",a.length);let e=(0,l.h$)(a),b=ap(e,aK);for(let c=0;c<b.length;c++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,b.length,b[c]),this.curSegmentNum++}addDisconnectPingFrame(b,c){if((0,l.Yr)())return;this.myDisconnFrame=document.createElement("iframe");let a={};a.dframe="t",a.id=b,a.pw=c,this.myDisconnFrame.src=this.urlFn(a),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(b){let a=(0,l.Pz)(b).length;this.bytesReceived+=a,this.stats_.incrementCounter("bytes_received",a)}}class aM{constructor(b,c,e,f){if(this.onDisconnect=e,this.urlFn=f,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0,(0,l.Yr)())this.commandCB=b,this.onMessageCB=c;else{this.uniqueCallbackIdentifier=$(),window["pLPCommand"+this.uniqueCallbackIdentifier]=b,window["pRTLPCB"+this.uniqueCallbackIdentifier]=c,this.myIFrame=aM.createIFrame_();let d="";if(this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,11)){let g=document.domain;d='<script>document.domain="'+g+'";</script>'}let h="<html><body>"+d+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(h),this.myIFrame.doc.close()}catch(a){ae("frame writing exception"),a.stack&&ae(a.stack),ae(a)}}}static createIFrame_(){let a=document.createElement("iframe");if(a.style.display="none",document.body){document.body.appendChild(a);try{let b=a.contentWindow.document;b||ae("No IE domain setting required")}catch(d){let c=document.domain;a.src="javascript:void((function(){document.open();document.domain='"+c+"';document.close();})())"}}else throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";return a.contentDocument?a.doc=a.contentDocument:a.contentWindow?a.doc=a.contentWindow.document:a.document&&(a.doc=a.document),a}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.innerHTML="",setTimeout(()=>{null!==this.myIFrame&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));let a=this.onDisconnect;a&&(this.onDisconnect=null,a())}startLongPoll(a,b){for(this.myID=a,this.myPW=b,this.alive=!0;this.newRequest_(););}newRequest_(){if(!this.alive||!this.sendNewPolls||!(this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)))return!1;{this.currentSerial++;let a={};a.id=this.myID,a.pw=this.myPW,a.ser=this.currentSerial;let e=this.urlFn(a),b="",c=0;for(;this.pendingSegs.length>0;){let f=this.pendingSegs[0];if(f.d.length+30+b.length<=1870){let d=this.pendingSegs.shift();b=b+"&seg"+c+"="+d.seg+"&ts"+c+"="+d.ts+"&d"+c+"="+d.d,c++}else break}return e+=b,this.addLongPollTag_(e,this.currentSerial),!0}}enqueueSegment(a,b,c){this.pendingSegs.push({seg:a,ts:b,d:c}),this.alive&&this.newRequest_()}addLongPollTag_(a,b){this.outstandingRequests.add(b);let c=()=>{this.outstandingRequests.delete(b),this.newRequest_()},d=setTimeout(c,Math.floor(25e3));this.addTag(a,()=>{clearTimeout(d),c()})}addTag(a,b){(0,l.Yr)()?this.doNodeLongPoll(a,b):setTimeout(()=>{try{if(!this.sendNewPolls)return;let c=this.myIFrame.doc.createElement("script");c.type="text/javascript",c.async=!0,c.src=a,c.onload=c.onreadystatechange=function(){let a=c.readyState;a&&"loaded"!==a&&"complete"!==a||(c.onload=c.onreadystatechange=null,c.parentNode&&c.parentNode.removeChild(c),b())},c.onerror=()=>{ae("Long-poll script failed to load: "+a),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(c)}catch(d){}},Math.floor(1))}}let p=null;"undefined"!=typeof MozWebSocket?p=MozWebSocket:"undefined"!=typeof WebSocket&&(p=WebSocket);class q{constructor(d,a,b,c,e,f,g){this.connId=d,this.applicationId=b,this.appCheckToken=c,this.authToken=e,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=af(this.connId),this.stats_=aH(a),this.connURL=q.connectionURL_(a,f,g,c,b),this.nodeAdmin=a.nodeAdmin}static connectionURL_(f,b,c,d,e){let a={};return a.v="5",!(0,l.Yr)()&&"undefined"!=typeof location&&location.hostname&&az.test(location.hostname)&&(a.r="f"),b&&(a.s=b),c&&(a.ls=c),d&&(a.ac=d),e&&(a.p=e),aD(f,aA,a)}open(f,g){this.onDisconnect=g,this.onMessage=f,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,X.set("previous_websocket_failure",!0);try{let a;if((0,l.Yr)()){let h=this.nodeAdmin?"AdminNode":"Node";a={headers:{"User-Agent":`Firebase/5/${G}/${U.platform}/${h}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(a.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(a.headers["X-Firebase-AppCheck"]=this.appCheckToken);let b=U.env,c=0===this.connURL.indexOf("wss://")?b.HTTPS_PROXY||b.https_proxy:b.HTTP_PROXY||b.http_proxy;c&&(a.proxy={origin:c})}this.mySock=new p(this.connURL,[],a)}catch(d){this.log_("Error instantiating WebSocket.");let e=d.message||d.data;e&&this.log_(e),this.onClosed_();return}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=a=>{this.handleIncomingFrame(a)},this.mySock.onerror=a=>{this.log_("WebSocket error.  Closing connection.");let b=a.message||a.data;b&&this.log_(b),this.onClosed_()}}start(){}static forceDisallow(){q.forceDisallow_=!0}static isAvailable(){let b=!1;if("undefined"!=typeof navigator&&navigator.userAgent){let c=/Android ([0-9]{0,}\.[0-9]{0,})/,a=navigator.userAgent.match(c);a&&a.length>1&&4.4>parseFloat(a[1])&&(b=!0)}return!b&&null!==p&&!q.forceDisallow_}static previouslyFailed(){return X.isInMemoryStorage||!0===X.get("previous_websocket_failure")}markConnectionHealthy(){X.remove("previous_websocket_failure")}appendFrame_(a){if(this.frames.push(a),this.frames.length===this.totalFrames){let b=this.frames.join("");this.frames=null;let c=(0,l.cI)(b);this.onMessage(c)}}handleNewFrameCount_(a){this.totalFrames=a,this.frames=[]}extractFrameCount_(a){if((0,l.hu)(null===this.frames,"We already have a frame buffer"),a.length<=6){let b=Number(a);if(!isNaN(b))return this.handleNewFrameCount_(b),null}return this.handleNewFrameCount_(1),a}handleIncomingFrame(c){if(null===this.mySock)return;let a=c.data;if(this.bytesReceived+=a.length,this.stats_.incrementCounter("bytes_received",a.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(a);else{let b=this.extractFrameCount_(a);null!==b&&this.appendFrame_(b)}}send(d){this.resetKeepAlive();let b=(0,l.Pz)(d);this.bytesSent+=b.length,this.stats_.incrementCounter("bytes_sent",b.length);let a=ap(b,16384);a.length>1&&this.sendString_(String(a.length));for(let c=0;c<a.length;c++)this.sendString_(a[c])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){!this.isClosed_&&(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(45e3))}sendString_(b){try{this.mySock.send(b)}catch(a){this.log_("Exception thrown from WebSocket.send():",a.message||a.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}q.responsesRequiredToBeHealthy=2,q.healthyTimeout=3e4;class L{constructor(a){this.initTransports_(a)}static get ALL_TRANSPORTS(){return[aL,q]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(d){let b=q&&q.isAvailable(),c=b&&!q.previouslyFailed();if(d.webSocketOnly&&(b||ai("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),c=!0),c)this.transports_=[q];else{let e=this.transports_=[];for(let a of L.ALL_TRANSPORTS)a&&a.isAvailable()&&e.push(a);L.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}L.globalTransportInitialized_=!1;class aN{constructor(b,a,c,d,e,f,g,h,i,j){this.id=b,this.repoInfo_=a,this.applicationId_=c,this.appCheckToken_=d,this.authToken_=e,this.onMessage_=f,this.onReady_=g,this.onDisconnect_=h,this.onKill_=i,this.lastSessionId=j,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=af("c:"+this.id+":"),this.transportManager_=new L(a),this.log_("Connection created"),this.start_()}start_(){let a=this.transportManager_.initialTransport();this.conn_=new a(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=a.responsesRequiredToBeHealthy||0;let c=this.connReceiver_(this.conn_),d=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(c,d)},Math.floor(0));let b=a.healthyTimeout||0;b>0&&(this.healthyTimeout_=aw(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>102400?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>10240?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(b)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(a){return b=>{a===this.conn_?this.onConnectionLost_(b):a===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(a){return b=>{2!==this.state_&&(a===this.rx_?this.onPrimaryMessageReceived_(b):a===this.secondaryConn_?this.onSecondaryMessageReceived_(b):this.log_("message on old connection"))}}sendRequest(a){this.sendData_({t:"d",d:a})}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(b){if("t"in b){let a=b.t;"a"===a?this.upgradeIfSecondaryHealthy_():"r"===a?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):"o"===a&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(b){let a=an("t",b),c=an("d",b);if("c"===a)this.onSecondaryControl_(c);else if("d"===a)this.pendingDataMessages.push(c);else throw Error("Unknown protocol layer: "+a)}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(a){let b=an("t",a),c=an("d",a);"c"===b?this.onControl_(c):"d"===b&&this.onDataMessage_(c)}onDataMessage_(a){this.onPrimaryResponse_(),this.onMessage_(a)}onPrimaryResponse_(){!this.isHealthy_&&(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(c){let a=an("t",c);if("d"in c){let b=c.d;if("h"===a)this.onHandshake_(b);else if("n"===a){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let d=0;d<this.pendingDataMessages.length;++d)this.onDataMessage_(this.pendingDataMessages[d]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===a?this.onConnectionShutdown_(b):"r"===a?this.onReset_(b):"e"===a?ag("Server Error: "+b):"o"===a?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):ag("Unknown control packet command: "+a)}}onHandshake_(a){let b=a.ts,c=a.v,d=a.h;this.sessionId=a.s,this.repoInfo_.host=d,0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,b),"5"!==c&&ai("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){let a=this.transportManager_.upgradeTransport();a&&this.startUpgrade_(a)}startUpgrade_(a){this.secondaryConn_=new a(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=a.responsesRequiredToBeHealthy||0;let b=this.connReceiver_(this.secondaryConn_),c=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(b,c),aw(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(6e4))}onReset_(a){this.log_("Reset packet received.  New host: "+a),this.repoInfo_.host=a,1===this.state_?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(a,b){this.log_("Realtime connection established."),this.conn_=a,this.state_=1,this.onReady_&&(this.onReady_(b,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):aw(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(5e3))}sendPingOnPrimaryIfNecessary_(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))}onSecondaryConnectionLost_(){let a=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===a||this.rx_===a)&&this.close()}onConnectionLost_(a){this.conn_=null,a||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(X.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()}onConnectionShutdown_(a){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(a),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(a){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(a)}close(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}
class r{put(a,b,c,d){}merge(a,b,c,d){}refreshAuthToken(a){}refreshAppCheckToken(a){}onDisconnectPut(a,b,c){}onDisconnectMerge(a,b,c){}onDisconnectCancel(a,b){}reportStats(a){}}
class s{constructor(a){this.allowedEvents_=a,this.listeners_={},(0,l.hu)(Array.isArray(a)&&a.length>0,"Requires a non-empty array")}trigger(c,...d){if(Array.isArray(this.listeners_[c])){let b=[...this.listeners_[c]];for(let a=0;a<b.length;a++)b[a].callback.apply(b[a].context,d)}}on(a,b,c){this.validateEventType_(a),this.listeners_[a]=this.listeners_[a]||[],this.listeners_[a].push({callback:b,context:c});let d=this.getInitialEvent(a);d&&b.apply(c,d)}off(c,e,d){this.validateEventType_(c);let b=this.listeners_[c]||[];for(let a=0;a<b.length;a++)if(b[a].callback===e&&(!d||d===b[a].context)){b.splice(a,1);return}}validateEventType_(a){(0,l.hu)(this.allowedEvents_.find(b=>b===a),"Unknown event: "+a)}}
class aO extends s{constructor(){super(["online"]),this.online_=!0,"undefined"==typeof window||void 0===window.addEventListener||(0,l.uI)()||(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new aO}getInitialEvent(a){return(0,l.hu)("online"===a,"Unknown event type: "+a),[this.online_]}currentlyOnline(){return this.online_}}class aP{constructor(c,d){if(void 0===d){this.pieces_=c.split("/");let b=0;for(let a=0;a<this.pieces_.length;a++)this.pieces_[a].length>0&&(this.pieces_[b]=this.pieces_[a],b++);this.pieces_.length=b,this.pieceNum_=0}else this.pieces_=c,this.pieceNum_=d}toString(){let b="";for(let a=this.pieceNum_;a<this.pieces_.length;a++)""!==this.pieces_[a]&&(b+="/"+this.pieces_[a]);return b||"/"}}function aQ(){return new aP("")}function aR(a){return a.pieceNum_>=a.pieces_.length?null:a.pieces_[a.pieceNum_]}function aS(a){return a.pieces_.length-a.pieceNum_}function aT(a){let b=a.pieceNum_;return b<a.pieces_.length&&b++,new aP(a.pieces_,b)}function aU(a){return a.pieceNum_<a.pieces_.length?a.pieces_[a.pieces_.length-1]:null}function aV(a,b=0){return a.pieces_.slice(a.pieceNum_+b)}function aW(a){if(a.pieceNum_>=a.pieces_.length)return null;let c=[];for(let b=a.pieceNum_;b<a.pieces_.length-1;b++)c.push(a.pieces_[b]);return new aP(c,0)}function aX(d,a){let b=[];for(let e=d.pieceNum_;e<d.pieces_.length;e++)b.push(d.pieces_[e]);if(a instanceof aP)for(let f=a.pieceNum_;f<a.pieces_.length;f++)b.push(a.pieces_[f]);else{let g=a.split("/");for(let c=0;c<g.length;c++)g[c].length>0&&b.push(g[c])}return new aP(b,0)}function aY(a){return a.pieceNum_>=a.pieces_.length}function aZ(b,a){let c=aR(b),d=aR(a);if(null===c)return a;if(c===d)return aZ(aT(b),aT(a));throw Error("INTERNAL ERROR: innerPath ("+a+") is not within outerPath ("+b+")")}function a$(e,f){let b=aV(e,0),c=aV(f,0);for(let a=0;a<b.length&&a<c.length;a++){let d=am(b[a],c[a]);if(0!==d)return d}return b.length===c.length?0:b.length<c.length?-1:1}function a_(a,b){if(aS(a)!==aS(b))return!1;for(let c=a.pieceNum_,d=b.pieceNum_;c<=a.pieces_.length;c++,d++)if(a.pieces_[c]!==b.pieces_[d])return!1;return!0}function a0(a,b){let c=a.pieceNum_,d=b.pieceNum_;if(aS(a)>aS(b))return!1;for(;c<a.pieces_.length;){if(a.pieces_[c]!==b.pieces_[d])return!1;++c,++d}return!0}class a1{constructor(b,c){this.errorPrefix_=c,this.parts_=aV(b,0),this.byteLength_=Math.max(1,this.parts_.length);for(let a=0;a<this.parts_.length;a++)this.byteLength_+=(0,l.ug)(this.parts_[a]);a2(this)}}function a2(a){if(a.byteLength_>768)throw Error(a.errorPrefix_+"has a key path longer than 768 bytes ("+a.byteLength_+").");if(a.parts_.length>32)throw Error(a.errorPrefix_+"path specified exceeds the maximum depth that can be written (32) or object contains a cycle "+a3(a))}function a3(a){return 0===a.parts_.length?"":"in property '"+a.parts_.join(".")+"'"}
class a4 extends s{constructor(){super(["visible"]);let b,a;"undefined"!=typeof document&&void 0!==document.addEventListener&&(void 0!==document.hidden?(a="visibilitychange",b="hidden"):void 0!==document.mozHidden?(a="mozvisibilitychange",b="mozHidden"):void 0!==document.msHidden?(a="msvisibilitychange",b="msHidden"):void 0!==document.webkitHidden&&(a="webkitvisibilitychange",b="webkitHidden")),this.visible_=!0,a&&document.addEventListener(a,()=>{let a=!document[b];a!==this.visible_&&(this.visible_=a,this.trigger("visible",a))},!1)}static getInstance(){return new a4}getInitialEvent(a){return(0,l.hu)("visible"===a,"Unknown event type: "+a),[this.visible_]}}class d extends r{constructor(a,c,e,f,g,h,i,b){if(super(),this.repoInfo_=a,this.applicationId_=c,this.onDataUpdate_=e,this.onConnectStatus_=f,this.onServerInfoUpdate_=g,this.authTokenProvider_=h,this.appCheckTokenProvider_=i,this.authOverride_=b,this.id=d.nextPersistentConnectionId_++,this.log_=af("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=1e3,this.maxReconnectDelay_=3e5,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,b&&!(0,l.Yr)())throw Error("Auth override specified in options, but not supported on non Node.js platforms");a4.getInstance().on("visible",this.onVisible_,this),-1===a.host.indexOf("fblocal")&&aO.getInstance().on("online",this.onOnline_,this)}sendRequest(d,e,a){let b=++this.requestNumber_,c={r:b,a:d,b:e};this.log_((0,l.Pz)(c)),(0,l.hu)(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(c),a&&(this.requestCBHash_[b]=a)}get(a){this.initConnection_();let b=new l.BH,c={p:a._path.toString(),q:a._queryObject},d={action:"g",request:c,onComplete(a){let c=a.d;"ok"===a.s?b.resolve(c):b.reject(c)}};this.outstandingGets_.push(d),this.outstandingGetCount_++;let e=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(e),b.promise}listen(a,e,f,g){this.initConnection_();let c=a._queryIdentifier,b=a._path.toString();this.log_("Listen called for "+b+" "+c),this.listens.has(b)||this.listens.set(b,new Map),(0,l.hu)(a._queryParams.isDefault()||!a._queryParams.loadsAllData(),"listen() called for non-default but complete query"),(0,l.hu)(!this.listens.get(b).has(c),"listen() called twice for same path/queryId.");let d={onComplete:g,hashFn:e,query:a,tag:f};this.listens.get(b).set(c,d),this.connected_&&this.sendListen_(d)}sendGet_(a){let b=this.outstandingGets_[a];this.sendRequest("g",b.request,c=>{delete this.outstandingGets_[a],this.outstandingGetCount_--,0===this.outstandingGetCount_&&(this.outstandingGets_=[]),b.onComplete&&b.onComplete(c)})}sendListen_(a){let c=a.query,e=c._path.toString(),f=c._queryIdentifier;this.log_("Listen on "+e+" for "+f);let b={p:e};a.tag&&(b.q=c._queryObject,b.t=a.tag),b.h=a.hashFn(),this.sendRequest("q",b,b=>{let g=b.d,h=b.s;d.warnOnListenWarnings_(g,c);let i=this.listens.get(e)&&this.listens.get(e).get(f);i===a&&(this.log_("listen response",b),"ok"!==h&&this.removeListen_(e,f),a.onComplete&&a.onComplete(h,g))})}static warnOnListenWarnings_(a,b){if(a&&"object"==typeof a&&(0,l.r3)(a,"w")){let c=(0,l.DV)(a,"w");if(Array.isArray(c)&&~c.indexOf("no_index")){let d='".indexOn": "'+b._queryParams.getIndex().toString()+'"',e=b._path.toString();ai(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${d} at ${e} to your security rules for better performance.`)}}}refreshAuthToken(a){this.authToken_=a,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(a)}reduceReconnectDelayIfAdminCredential_(a){let b=a&&40===a.length;(b||(0,l.GJ)(a))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3e4)}refreshAppCheckToken(a){this.appCheckToken_=a,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){let b=this.authToken_,c=(0,l.w9)(b)?"auth":"gauth",a={cred:b};null===this.authOverride_?a.noauth=!0:"object"==typeof this.authOverride_&&(a.authvar=this.authOverride_),this.sendRequest(c,a,a=>{let c=a.s,d=a.d||"error";this.authToken_===b&&("ok"===c?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(c,d))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},a=>{let b=a.s,c=a.d||"error";"ok"===b?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(b,c)})}unlisten(a,d){let b=a._path.toString(),c=a._queryIdentifier;this.log_("Unlisten called for "+b+" "+c),(0,l.hu)(a._queryParams.isDefault()||!a._queryParams.loadsAllData(),"unlisten() called for non-default but complete query");let e=this.removeListen_(b,c);e&&this.connected_&&this.sendUnlisten_(b,c,a._queryObject,d)}sendUnlisten_(b,d,e,c){this.log_("Unlisten on "+b+" for "+d);let a={p:b};c&&(a.q=e,a.t=c),this.sendRequest("n",a)}onDisconnectPut(a,b,c){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",a,b,c):this.onDisconnectRequestQueue_.push({pathString:a,action:"o",data:b,onComplete:c})}onDisconnectMerge(a,b,c){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",a,b,c):this.onDisconnectRequestQueue_.push({pathString:a,action:"om",data:b,onComplete:c})}onDisconnectCancel(a,b){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",a,null,b):this.onDisconnectRequestQueue_.push({pathString:a,action:"oc",data:null,onComplete:b})}sendOnDisconnect_(a,c,d,e){let b={p:c,d:d};this.log_("onDisconnect "+a,b),this.sendRequest(a,b,a=>{e&&setTimeout(()=>{e(a.s,a.d)},Math.floor(0))})}put(a,b,c,d){this.putInternal("p",a,b,c,d)}merge(a,b,c,d){this.putInternal("m",a,b,c,d)}putInternal(d,a,e,f,b){this.initConnection_();let c={p:a,d:e};void 0!==b&&(c.h=b),this.outstandingPuts_.push({action:d,request:c,onComplete:f}),this.outstandingPutCount_++;let g=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(g):this.log_("Buffering put: "+a)}sendPut_(a){let b=this.outstandingPuts_[a].action,c=this.outstandingPuts_[a].request,d=this.outstandingPuts_[a].onComplete;this.outstandingPuts_[a].queued=this.connected_,this.sendRequest(b,c,c=>{this.log_(b+" response",c),delete this.outstandingPuts_[a],this.outstandingPutCount_--,0===this.outstandingPutCount_&&(this.outstandingPuts_=[]),d&&d(c.s,c.d)})}reportStats(b){if(this.connected_){let a={c:b};this.log_("reportStats",a),this.sendRequest("s",a,a=>{let b=a.s;if("ok"!==b){let c=a.d;this.log_("reportStats","Error sending stats: "+c)}})}}onDataMessage_(a){if("r"in a){this.log_("from server: "+(0,l.Pz)(a));let b=a.r,c=this.requestCBHash_[b];c&&(delete this.requestCBHash_[b],c(a.b))}else if("error"in a)throw"A server-side error has occurred: "+a.error;else"a"in a&&this.onDataPush_(a.a,a.b)}onDataPush_(b,a){this.log_("handleServerMessage",b,a),"d"===b?this.onDataUpdate_(a.p,a.d,!1,a.t):"m"===b?this.onDataUpdate_(a.p,a.d,!0,a.t):"c"===b?this.onListenRevoked_(a.p,a.q):"ac"===b?this.onAuthRevoked_(a.s,a.d):"apc"===b?this.onAppCheckRevoked_(a.s,a.d):"sd"===b?this.onSecurityDebugPacket_(a):ag("Unrecognized action received from server: "+(0,l.Pz)(b)+"\nAre you using the latest client?")}onReady_(a,b){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=new Date().getTime(),this.handleTimestamp_(a),this.lastSessionId=b,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(a){(0,l.hu)(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(a))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(a){!a||this.visible_||this.reconnectDelay_!==this.maxReconnectDelay_||(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0)),this.visible_=a}onOnline_(a){a?(this.log_("Browser went online."),this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){if(this.visible_){if(this.lastConnectionEstablishedTime_){let b=new Date().getTime()-this.lastConnectionEstablishedTime_;b>3e4&&(this.reconnectDelay_=1e3),this.lastConnectionEstablishedTime_=null}}else this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=new Date().getTime();let c=new Date().getTime()-this.lastConnectionAttemptTime_,a=Math.max(0,this.reconnectDelay_-c);a=Math.random()*a,this.log_("Trying to reconnect in "+a+"ms"),this.scheduleConnect_(a),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=new Date().getTime(),this.lastConnectionEstablishedTime_=null;let h=this.onDataMessage_.bind(this),i=this.onReady_.bind(this),j=this.onRealtimeDisconnect_.bind(this),k=this.id+":"+d.nextConnectionId_++,m=this.lastSessionId,a=!1,n=null,b=function(){n?n.close():(a=!0,j())},o=function(a){(0,l.hu)(n,"sendRequest call when we're not connected not allowed."),n.sendRequest(a)};this.realtime_={close:b,sendRequest:o};let c=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{let[e,f]=await Promise.all([this.authTokenProvider_.getToken(c),this.appCheckTokenProvider_.getToken(c)]);a?ae("getToken() completed but was canceled"):(ae("getToken() completed. Creating connection."),this.authToken_=e&&e.accessToken,this.appCheckToken_=f&&f.token,n=new aN(k,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,h,i,j,a=>{ai(a+" ("+this.repoInfo_.toString()+")"),this.interrupt("server_kill")},m))}catch(g){this.log_("Failed to get token: "+g),a||(this.repoInfo_.nodeAdmin&&ai(g),b())}}}interrupt(a){ae("Interrupting connection for reason: "+a),this.interruptReasons_[a]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(a){ae("Resuming connection for reason: "+a),delete this.interruptReasons_[a],(0,l.xb)(this.interruptReasons_)&&(this.reconnectDelay_=1e3,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(a){let b=a-new Date().getTime();this.onServerInfoUpdate_({serverTimeOffset:b})}cancelSentTransactions_(){for(let b=0;b<this.outstandingPuts_.length;b++){let a=this.outstandingPuts_[b];a&&"h"in a.request&&a.queued&&(a.onComplete&&a.onComplete("disconnect"),delete this.outstandingPuts_[b],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])}onListenRevoked_(d,b){let c;c=b?b.map(a=>ao(a)).join("$"):"default";let a=this.removeListen_(d,c);a&&a.onComplete&&a.onComplete("permission_denied")}removeListen_(e,d){let a=new aP(e).toString(),b;if(this.listens.has(a)){let c=this.listens.get(a);b=c.get(d),c.delete(d),0===c.size&&this.listens.delete(a)}else b=void 0;return b}onAuthRevoked_(a,b){ae("Auth token revoked: "+a+"/"+b),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),("invalid_token"===a||"permission_denied"===a)&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=3&&(this.reconnectDelay_=3e4,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(a,b){ae("App check token revoked: "+a+"/"+b),this.appCheckToken_=null,this.forceTokenRefresh_=!0,("invalid_token"===a||"permission_denied"===a)&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=3&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(a){this.securityDebugCallback_?this.securityDebugCallback_(a):"msg"in a&&console.log("FIREBASE: "+a.msg.replace("\n","\nFIREBASE: "))}restoreState_(){for(let d of(this.tryAuth(),this.tryAppCheck(),this.listens.values()))for(let e of d.values())this.sendListen_(e);for(let a=0;a<this.outstandingPuts_.length;a++)this.outstandingPuts_[a]&&this.sendPut_(a);for(;this.onDisconnectRequestQueue_.length;){let b=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(b.action,b.pathString,b.data,b.onComplete)}for(let c=0;c<this.outstandingGets_.length;c++)this.outstandingGets_[c]&&this.sendGet_(c)}sendConnectStats_(){let a={},b="js";(0,l.Yr)()&&(b=this.repoInfo_.nodeAdmin?"admin_node":"node"),a["sdk."+b+"."+G.replace(/\./g,"-")]=1,(0,l.uI)()?a["framework.cordova"]=1:(0,l.b$)()&&(a["framework.reactnative"]=1),this.reportStats(a)}shouldReconnect_(){let a=aO.getInstance().currentlyOnline();return(0,l.xb)(this.interruptReasons_)&&a}}d.nextPersistentConnectionId_=0,d.nextConnectionId_=0;class f{constructor(a,b){this.name=a,this.node=b}static Wrap(a,b){return new f(a,b)}}
class t{getCompare(){return this.compare.bind(this)}indexedValueChanged(a,b){let c=new f(I,a),d=new f(I,b);return 0!==this.compare(c,d)}minPost(){return f.MIN}}
let a5;class u extends t{static get __EMPTY_NODE(){return a5}static set __EMPTY_NODE(a){a5=a}compare(a,b){return am(a.name,b.name)}isDefinedOn(a){throw(0,l.g5)("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(a,b){return!1}minPost(){return f.MIN}maxPost(){return new f(J,a5)}makePost(a,b){return(0,l.hu)("string"==typeof a,"KeyIndex indexValue must always be a string."),new f(a,a5)}toString(){return".key"}}let a6=new u;class a7{constructor(a,c,e,d,f=null){this.isReverse_=d,this.resultGenerator_=f,this.nodeStack_=[];let b=1;for(;!a.isEmpty();)if(b=c?e(a.key,c):1,d&&(b*=-1),b<0)a=this.isReverse_?a.left:a.right;else if(0===b){this.nodeStack_.push(a);break}else this.nodeStack_.push(a),a=this.isReverse_?a.right:a.left}getNext(){if(0===this.nodeStack_.length)return null;let a=this.nodeStack_.pop(),b;if(b=this.resultGenerator_?this.resultGenerator_(a.key,a.value):{key:a.key,value:a.value},this.isReverse_)for(a=a.left;!a.isEmpty();)this.nodeStack_.push(a),a=a.right;else for(a=a.right;!a.isEmpty();)this.nodeStack_.push(a),a=a.left;return b}hasNext(){return this.nodeStack_.length>0}peek(){if(0===this.nodeStack_.length)return null;let a=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(a.key,a.value):{key:a.key,value:a.value}}}class v{constructor(d,e,a,b,c){this.key=d,this.value=e,this.color=null!=a?a:v.RED,this.left=null!=b?b:M.EMPTY_NODE,this.right=null!=c?c:M.EMPTY_NODE}copy(a,b,c,d,e){return new v(null!=a?a:this.key,null!=b?b:this.value,null!=c?c:this.color,null!=d?d:this.left,null!=e?e:this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(a){return this.left.inorderTraversal(a)||!!a(this.key,this.value)||this.right.inorderTraversal(a)}reverseTraversal(a){return this.right.reverseTraversal(a)||a(this.key,this.value)||this.left.reverseTraversal(a)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(b,c,d){let a=this,e=d(b,a.key);return(a=e<0?a.copy(null,null,null,a.left.insert(b,c,d),null):0===e?a.copy(null,c,null,null,null):a.copy(null,null,null,null,a.right.insert(b,c,d))).fixUp_()}removeMin_(){if(this.left.isEmpty())return M.EMPTY_NODE;let a=this;return a.left.isRed_()||a.left.left.isRed_()||(a=a.moveRedLeft_()),(a=a.copy(null,null,null,a.left.removeMin_(),null)).fixUp_()}remove(b,c){let a,d;if(a=this,0>c(b,a.key))a.left.isEmpty()||a.left.isRed_()||a.left.left.isRed_()||(a=a.moveRedLeft_()),a=a.copy(null,null,null,a.left.remove(b,c),null);else{if(a.left.isRed_()&&(a=a.rotateRight_()),a.right.isEmpty()||a.right.isRed_()||a.right.left.isRed_()||(a=a.moveRedRight_()),0===c(b,a.key)){if(a.right.isEmpty())return M.EMPTY_NODE;d=a.right.min_(),a=a.copy(d.key,d.value,null,null,a.right.removeMin_())}a=a.copy(null,null,null,null,a.right.remove(b,c))}return a.fixUp_()}isRed_(){return this.color}fixUp_(){let a=this;return a.right.isRed_()&&!a.left.isRed_()&&(a=a.rotateLeft_()),a.left.isRed_()&&a.left.left.isRed_()&&(a=a.rotateRight_()),a.left.isRed_()&&a.right.isRed_()&&(a=a.colorFlip_()),a}moveRedLeft_(){let a=this.colorFlip_();return a.right.left.isRed_()&&(a=(a=(a=a.copy(null,null,null,null,a.right.rotateRight_())).rotateLeft_()).colorFlip_()),a}moveRedRight_(){let a=this.colorFlip_();return a.left.left.isRed_()&&(a=(a=a.rotateRight_()).colorFlip_()),a}rotateLeft_(){let a=this.copy(null,null,v.RED,null,this.right.left);return this.right.copy(null,null,this.color,a,null)}rotateRight_(){let a=this.copy(null,null,v.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,a)}colorFlip_(){let a=this.left.copy(null,null,!this.left.color,null,null),b=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,a,b)}checkMaxDepth_(){let a=this.check_();return Math.pow(2,a)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw Error("Right child of ("+this.key+","+this.value+") is red");let a=this.left.check_();if(a===this.right.check_())return a+(this.isRed_()?0:1);throw Error("Black depths differ")}}v.RED=!0,v.BLACK=!1;class M{constructor(a,b=M.EMPTY_NODE){this.comparator_=a,this.root_=b}insert(a,b){return new M(this.comparator_,this.root_.insert(a,b,this.comparator_).copy(null,null,v.BLACK,null,null))}remove(a){return new M(this.comparator_,this.root_.remove(a,this.comparator_).copy(null,null,v.BLACK,null,null))}get(c){let b,a=this.root_;for(;!a.isEmpty();){if(0===(b=this.comparator_(c,a.key)))return a.value;b<0?a=a.left:b>0&&(a=a.right)}return null}getPredecessorKey(d){let b,a=this.root_,c=null;for(;!a.isEmpty();){if(0===(b=this.comparator_(d,a.key))){if(a.left.isEmpty()){if(c)return c.key;return null}for(a=a.left;!a.right.isEmpty();)a=a.right;return a.key}b<0?a=a.left:b>0&&(c=a,a=a.right)}throw Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(a){return this.root_.inorderTraversal(a)}reverseTraversal(a){return this.root_.reverseTraversal(a)}getIterator(a){return new a7(this.root_,null,this.comparator_,!1,a)}getIteratorFrom(a,b){return new a7(this.root_,a,this.comparator_,!1,b)}getReverseIteratorFrom(a,b){return new a7(this.root_,a,this.comparator_,!0,b)}getReverseIterator(a){return new a7(this.root_,null,this.comparator_,!0,a)}}
function a8(a,b){return am(a.name,b.name)}function a9(a,b){return am(a,b)}M.EMPTY_NODE=new class{copy(a,b,c,d,e){return this}insert(a,b,c){return new v(a,b,null)}remove(a,b){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(a){return!1}reverseTraversal(a){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}};let N,ba=function(a){return"number"==typeof a?"number:"+ar(a):"string:"+a},bb=function(a){if(a.isLeafNode()){let b=a.val();(0,l.hu)("string"==typeof b||"number"==typeof b||"object"==typeof b&&(0,l.r3)(b,".sv"),"Priority must be a string or number.")}else(0,l.hu)(a===N||a.isEmpty(),"priority of unexpected type.");(0,l.hu)(a===N||a.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")},bc;class w{constructor(a,b=w.__childrenNodeConstructor.EMPTY_NODE){this.value_=a,this.priorityNode_=b,this.lazyHash_=null,(0,l.hu)(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value."),bb(this.priorityNode_)}static set __childrenNodeConstructor(a){bc=a}static get __childrenNodeConstructor(){return bc}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(a){return new w(this.value_,a)}getImmediateChild(a){return".priority"===a?this.priorityNode_:w.__childrenNodeConstructor.EMPTY_NODE}getChild(a){return aY(a)?this:".priority"===aR(a)?this.priorityNode_:w.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(a,b){return null}updateImmediateChild(a,b){return".priority"===a?this.updatePriority(b):b.isEmpty()&&".priority"!==a?this:w.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(a,b).updatePriority(this.priorityNode_)}updateChild(b,c){let a=aR(b);return null===a?c:c.isEmpty()&&".priority"!==a?this:((0,l.hu)(".priority"!==a||1===aS(b),".priority must be the last token in a path"),this.updateImmediateChild(a,w.__childrenNodeConstructor.EMPTY_NODE.updateChild(aT(b),c)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(a,b){return!1}val(a){return a&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(null===this.lazyHash_){let a="";this.priorityNode_.isEmpty()||(a+="priority:"+ba(this.priorityNode_.val())+":");let b=typeof this.value_;a+=b+":","number"===b?a+=ar(this.value_):a+=this.value_,this.lazyHash_=_(a)}return this.lazyHash_}getValue(){return this.value_}compareTo(a){return a===w.__childrenNodeConstructor.EMPTY_NODE?1:a instanceof w.__childrenNodeConstructor?-1:((0,l.hu)(a.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(a))}compareToLeafNode_(a){let e=typeof a.value_,b=typeof this.value_,c=w.VALUE_TYPE_ORDER.indexOf(e),d=w.VALUE_TYPE_ORDER.indexOf(b);return((0,l.hu)(c>=0,"Unknown leaf type: "+e),(0,l.hu)(d>=0,"Unknown leaf type: "+b),c!==d)?d-c:"object"===b?0:this.value_<a.value_?-1:this.value_===a.value_?0:1}withIndex(){return this}isIndexed(){return!0}equals(a){if(a===this)return!0;if(!a.isLeafNode())return!1;{let b=a;return this.value_===b.value_&&this.priorityNode_.equals(b.priorityNode_)}}}w.VALUE_TYPE_ORDER=["object","boolean","number","string"];let O,P,bd=new class extends t{compare(a,b){let d=a.node.getPriority(),e=b.node.getPriority(),c=d.compareTo(e);return 0===c?am(a.name,b.name):c}isDefinedOn(a){return!a.getPriority().isEmpty()}indexedValueChanged(a,b){return!a.getPriority().equals(b.getPriority())}minPost(){return f.MIN}maxPost(){return new f(J,new w("[PRIORITY-POST]",P))}makePost(a,b){let c=O(a);return new f(b,new w("[PRIORITY-POST]",c))}toString(){return".priority"}},be=Math.log(2);class bf{constructor(a){var c,d;this.count=parseInt(Math.log(a+1)/be,10),this.current_=this.count-1;let b=parseInt(Array(this.count+1).join("1"),2);this.bits_=a+1&b}nextBitIsOne(){let a=!(this.bits_&1<<this.current_);return this.current_--,a}}let bg=function(a,b,f,c){a.sort(b);let g=function(c,i){let e=i-c,b,d;if(0===e)return null;if(1===e)return b=a[c],d=f?f(b):b,new v(d,b.node,v.BLACK,null,null);{let h=parseInt(e/2,10)+c,j=g(c,h),k=g(h+1,i);return b=a[h],d=f?f(b):b,new v(d,b.node,v.BLACK,j,k)}},d=new bf(a.length),e=function(b){let j=null,h=null,k=a.length,c=function(c,e){let d=k-c,h=k;k-=c;let i=g(d+1,h),b=a[d],j=f?f(b):b;l(new v(j,b.node,e,null,i))},l=function(a){j?(j.left=a,j=a):(h=a,j=a)};for(let d=0;d<b.count;++d){let i=b.nextBitIsOne(),e=Math.pow(2,b.count-(d+1));i?c(e,v.BLACK):(c(e,v.BLACK),c(e,v.RED))}return h}(d);return new M(c||b,e)},bh,bi={};class bj{constructor(a,b){this.indexes_=a,this.indexSet_=b}static get Default(){return(0,l.hu)(bi&&bd,"ChildrenNode.ts has not been loaded"),bh=bh||new bj({".priority":bi},{".priority":bd})}get(b){let a=(0,l.DV)(this.indexes_,b);if(!a)throw Error("No index defined for "+b);return a instanceof M?a:null}hasIndex(a){return(0,l.r3)(this.indexSet_,a.toString())}addIndex(a,k){(0,l.hu)(a!==a6,"KeyIndex always exists and isn't meant to be added to the IndexMap.");let d=[],c=!1,e=k.getIterator(f.Wrap),b=e.getNext();for(;b;)c=c||a.isDefinedOn(b.node),d.push(b),b=e.getNext();let g;g=c?bg(d,a.getCompare()):bi;let h=a.toString(),i=Object.assign({},this.indexSet_);i[h]=a;let j=Object.assign({},this.indexes_);return j[h]=g,new bj(j,i)}addToIndexes(b,c){let a=(0,l.UI)(this.indexes_,(h,i)=>{let d=(0,l.DV)(this.indexSet_,i);if((0,l.hu)(d,"Missing index implementation for "+i),h===bi){if(!d.isDefinedOn(b.node))return bi;{let e=[],j=c.getIterator(f.Wrap),a=j.getNext();for(;a;)a.name!==b.name&&e.push(a),a=j.getNext();return e.push(b),bg(e,d.getCompare())}}{let k=c.get(b.name),g=h;return k&&(g=g.remove(new f(b.name,k))),g.insert(b,b.node)}});return new bj(a,this.indexSet_)}removeFromIndexes(b,c){let a=(0,l.UI)(this.indexes_,a=>{if(a===bi)return a;{let d=c.get(b.name);return d?a.remove(new f(b.name,d)):a}});return new bj(a,this.indexSet_)}}
let bk;class e{constructor(a,b,c){this.children_=a,this.priorityNode_=b,this.indexMap_=c,this.lazyHash_=null,this.priorityNode_&&bb(this.priorityNode_),this.children_.isEmpty()&&(0,l.hu)(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return bk||(bk=new e(new M(a9),null,bj.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||bk}updatePriority(a){return this.children_.isEmpty()?this:new e(this.children_,a,this.indexMap_)}getImmediateChild(a){if(".priority"===a)return this.getPriority();{let b=this.children_.get(a);return null===b?bk:b}}getChild(a){let b=aR(a);return null===b?this:this.getImmediateChild(b).getChild(aT(a))}hasChild(a){return null!==this.children_.get(a)}updateImmediateChild(b,a){if((0,l.hu)(a,"We should always be passing snapshot nodes"),".priority"===b)return this.updatePriority(a);{let g=new f(b,a),c,d;a.isEmpty()?(c=this.children_.remove(b),d=this.indexMap_.removeFromIndexes(g,this.children_)):(c=this.children_.insert(b,a),d=this.indexMap_.addToIndexes(g,this.children_));let h=c.isEmpty()?bk:this.priorityNode_;return new e(c,h,d)}}updateChild(a,c){let b=aR(a);if(null===b)return c;{(0,l.hu)(".priority"!==aR(a)||1===aS(a),".priority must be the last token in a path");let d=this.getImmediateChild(b).updateChild(aT(a),c);return this.updateImmediateChild(b,d)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(b){if(this.isEmpty())return null;let a={},f=0,g=0,h=!0;if(this.forEachChild(bd,(c,d)=>{a[c]=d.val(b),f++,h&&e.INTEGER_REGEXP_.test(c)?g=Math.max(g,Number(c)):h=!1}),b||!h||!(g<2*f))return b&&!this.getPriority().isEmpty()&&(a[".priority"]=this.getPriority().val()),a;{let c=[];for(let d in a)c[d]=a[d];return c}}hash(){if(null===this.lazyHash_){let a="";this.getPriority().isEmpty()||(a+="priority:"+ba(this.getPriority().val())+":"),this.forEachChild(bd,(c,d)=>{let b=d.hash();""!==b&&(a+=":"+c+":"+b)}),this.lazyHash_=""===a?"":_(a)}return this.lazyHash_}getPredecessorChildName(a,d,e){let b=this.resolveIndex_(e);if(!b)return this.children_.getPredecessorKey(a);{let c=b.getPredecessorKey(new f(a,d));return c?c.name:null}}getFirstChildName(c){let a=this.resolveIndex_(c);if(!a)return this.children_.minKey();{let b=a.minKey();return b&&b.name}}getFirstChild(b){let a=this.getFirstChildName(b);return a?new f(a,this.children_.get(a)):null}getLastChildName(c){let a=this.resolveIndex_(c);if(!a)return this.children_.maxKey();{let b=a.maxKey();return b&&b.name}}getLastChild(b){let a=this.getLastChildName(b);return a?new f(a,this.children_.get(a)):null}forEachChild(b,c){let a=this.resolveIndex_(b);return a?a.inorderTraversal(a=>c(a.name,a.node)):this.children_.inorderTraversal(c)}getIterator(a){return this.getIteratorFrom(a.minPost(),a)}getIteratorFrom(b,d){let e=this.resolveIndex_(d);if(e)return e.getIteratorFrom(b,a=>a);{let a=this.children_.getIteratorFrom(b.name,f.Wrap),c=a.peek();for(;null!=c&&0>d.compare(c,b);)a.getNext(),c=a.peek();return a}}getReverseIterator(a){return this.getReverseIteratorFrom(a.maxPost(),a)}getReverseIteratorFrom(b,d){let e=this.resolveIndex_(d);if(e)return e.getReverseIteratorFrom(b,a=>a);{let a=this.children_.getReverseIteratorFrom(b.name,f.Wrap),c=a.peek();for(;null!=c&&d.compare(c,b)>0;)a.getNext(),c=a.peek();return a}}compareTo(a){return this.isEmpty()?a.isEmpty()?0:-1:a.isLeafNode()||a.isEmpty()?1:a===g?-1:0}withIndex(a){if(a===a6||this.indexMap_.hasIndex(a))return this;{let b=this.indexMap_.addIndex(a,this.children_);return new e(this.children_,this.priorityNode_,b)}}isIndexed(a){return a===a6||this.indexMap_.hasIndex(a)}equals(c){if(c===this)return!0;if(c.isLeafNode())return!1;{let d=c;if(!this.getPriority().equals(d.getPriority()))return!1;if(this.children_.count()!==d.children_.count())return!1;{let e=this.getIterator(bd),f=d.getIterator(bd),a=e.getNext(),b=f.getNext();for(;a&&b;){if(a.name!==b.name||!a.node.equals(b.node))return!1;a=e.getNext(),b=f.getNext()}return null===a&&null===b}}}resolveIndex_(a){return a===a6?null:this.indexMap_.get(a.toString())}}e.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;let g=new class extends e{constructor(){super(new M(a9),e.EMPTY_NODE,bj.Default)}compareTo(a){return a===this?0:1}equals(a){return a===this}getPriority(){return this}getImmediateChild(a){return e.EMPTY_NODE}isEmpty(){return!1}};function Q(a,b=null){if(null===a)return e.EMPTY_NODE;if("object"==typeof a&&".priority"in a&&(b=a[".priority"]),(0,l.hu)(null===b||"string"==typeof b||"number"==typeof b||"object"==typeof b&&".sv"in b,"Invalid priority type found: "+typeof b),"object"==typeof a&&".value"in a&&null!==a[".value"]&&(a=a[".value"]),"object"!=typeof a||".sv"in a){let g=a;return new w(g,Q(b))}if(a instanceof Array){let h=e.EMPTY_NODE;return aq(a,(b,d)=>{if((0,l.r3)(a,b)&&"."!==b.substring(0,1)){let c=Q(d);(c.isLeafNode()||!c.isEmpty())&&(h=h.updateImmediateChild(b,c))}}),h.updatePriority(Q(b))}{let c=[],i=!1,j=a;if(aq(j,(b,d)=>{if("."!==b.substring(0,1)){let a=Q(d);a.isEmpty()||(i=i||!a.getPriority().isEmpty(),c.push(new f(b,a)))}}),0===c.length)return e.EMPTY_NODE;let d=bg(c,a8,a=>a.name,a9);if(!i)return new e(d,Q(b),bj.Default);{let k=bg(c,bd.getCompare());return new e(d,Q(b),new bj({".priority":k},{".priority":bd}))}}}Object.defineProperties(f,{MIN:{value:new f(I,e.EMPTY_NODE)},MAX:{value:new f(J,g)}}),u.__EMPTY_NODE=e.EMPTY_NODE,w.__childrenNodeConstructor=e,N=B=g,h=g,P=h,O=C=Q;class bl extends t{constructor(a){super(),this.indexPath_=a,(0,l.hu)(!aY(a)&&".priority"!==aR(a),"Can't create PathIndex with empty path or .priority key")}extractChild(a){return a.getChild(this.indexPath_)}isDefinedOn(a){return!a.getChild(this.indexPath_).isEmpty()}compare(a,b){let d=this.extractChild(a.node),e=this.extractChild(b.node),c=d.compareTo(e);return 0===c?am(a.name,b.name):c}makePost(a,b){let c=Q(a),d=e.EMPTY_NODE.updateChild(this.indexPath_,c);return new f(b,d)}maxPost(){let a=e.EMPTY_NODE.updateChild(this.indexPath_,g);return new f(J,a)}toString(){return aV(this.indexPath_,0).join("/")}}let bm=new
class extends t{compare(a,b){let c=a.node.compareTo(b.node);return 0===c?am(a.name,b.name):c}isDefinedOn(a){return!0}indexedValueChanged(a,b){return!a.equals(b)}minPost(){return f.MIN}maxPost(){return f.MAX}makePost(a,b){let c=Q(a);return new f(b,c)}toString(){return".value"}},bn="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",bo=function(){let a=0,b=[];return function(d){let g=d===a;a=d;let c,f=Array(8);for(c=7;c>=0;c--)f[c]=bn.charAt(d%64),d=Math.floor(d/64);(0,l.hu)(0===d,"Cannot push at time == 0");let e=f.join("");if(g){for(c=11;c>=0&&63===b[c];c--)b[c]=0;b[c]++}else for(c=0;c<12;c++)b[c]=Math.floor(64*Math.random());for(c=0;c<12;c++)e+=bn.charAt(b[c]);return(0,l.hu)(20===e.length,"nextPushId: Length should be 20."),e}}(),bp=function(c){if("2147483647"===c)return"-";let e=at(c);if(null!=e)return""+(e+1);let a=Array(c.length);for(let d=0;d<a.length;d++)a[d]=c.charAt(d);if(a.length<786)return a.push("-"),a.join("");let b=a.length-1;for(;b>=0&&"z"===a[b];)b--;if(-1===b)return J;let f=a[b],g=bn.charAt(bn.indexOf(f)+1);return a[b]=g,a.slice(0,b+1).join("")},bq=function(b){if("-2147483648"===b)return I;let d=at(b);if(null!=d)return""+(d-1);let a=Array(b.length);for(let c=0;c<a.length;c++)a[c]=b.charAt(c);return"-"===a[a.length-1]?1===a.length?"2147483647":(delete a[a.length-1],a.join("")):(a[a.length-1]=bn.charAt(bn.indexOf(a[a.length-1])-1),a.join("")+"z".repeat(786-a.length))};function br(a){return{type:"value",snapshotNode:a}}function bs(a,b){return{type:"child_added",snapshotNode:b,childName:a}}function bt(a,b){return{type:"child_removed",snapshotNode:b,childName:a}}function bu(a,b,c){return{type:"child_changed",snapshotNode:b,childName:a,oldSnap:c}}
class bv{constructor(a){this.index_=a}updateChild(a,c,b,f,g,e){(0,l.hu)(a.isIndexed(this.index_),"A node must be indexed if only a child is updated");let d=a.getImmediateChild(c);return d.getChild(f).equals(b.getChild(f))&&d.isEmpty()===b.isEmpty()?a:(null!=e&&(b.isEmpty()?a.hasChild(c)?e.trackChildChange(bt(c,d)):(0,l.hu)(a.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):d.isEmpty()?e.trackChildChange(bs(c,b)):e.trackChildChange(bu(c,b,d))),a.isLeafNode()&&b.isEmpty())?a:a.updateImmediateChild(c,b).withIndex(this.index_)}updateFullNode(b,a,c){return null==c||(b.isLeafNode()||b.forEachChild(bd,(b,d)=>{a.hasChild(b)||c.trackChildChange(bt(b,d))}),a.isLeafNode()||a.forEachChild(bd,(a,d)=>{if(b.hasChild(a)){let e=b.getImmediateChild(a);e.equals(d)||c.trackChildChange(bu(a,d,e))}else c.trackChildChange(bs(a,d))})),a.withIndex(this.index_)}updatePriority(a,b){return a.isEmpty()?e.EMPTY_NODE:a.updatePriority(b)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}
class bw{constructor(a){this.indexedFilter_=new bv(a.getIndex()),this.index_=a.getIndex(),this.startPost_=bw.getStartPost_(a),this.endPost_=bw.getEndPost_(a)}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(a){return 0>=this.index_.compare(this.getStartPost(),a)&&0>=this.index_.compare(a,this.getEndPost())}updateChild(c,b,a,d,g,h){return this.matches(new f(b,a))||(a=e.EMPTY_NODE),this.indexedFilter_.updateChild(c,b,a,d,g,h)}updateFullNode(c,a,d){a.isLeafNode()&&(a=e.EMPTY_NODE);let b=a.withIndex(this.index_);b=b.updatePriority(e.EMPTY_NODE);let g=this;return a.forEachChild(bd,(a,c)=>{g.matches(new f(a,c))||(b=b.updateImmediateChild(a,e.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(c,b,d)}updatePriority(a,b){return a}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(a){if(!a.hasStart())return a.getIndex().minPost();{let b=a.getIndexStartName();return a.getIndex().makePost(a.getIndexStartValue(),b)}}static getEndPost_(a){if(!a.hasEnd())return a.getIndex().maxPost();{let b=a.getIndexEndName();return a.getIndex().makePost(a.getIndexEndValue(),b)}}}
class bx{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=bd}hasStart(){return this.startSet_}hasStartAfter(){return this.startAfterSet_}hasEndBefore(){return this.endBeforeSet_}isViewFromLeft(){return""===this.viewFrom_?this.startSet_:"l"===this.viewFrom_}getIndexStartValue(){return(0,l.hu)(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return((0,l.hu)(this.startSet_,"Only valid if start has been set"),this.startNameSet_)?this.indexStartName_:I}hasEnd(){return this.endSet_}getIndexEndValue(){return(0,l.hu)(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return((0,l.hu)(this.endSet_,"Only valid if end has been set"),this.endNameSet_)?this.indexEndName_:J}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&""!==this.viewFrom_}getLimit(){return(0,l.hu)(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===bd}copy(){let a=new bx;return a.limitSet_=this.limitSet_,a.limit_=this.limit_,a.startSet_=this.startSet_,a.indexStartValue_=this.indexStartValue_,a.startNameSet_=this.startNameSet_,a.indexStartName_=this.indexStartName_,a.endSet_=this.endSet_,a.indexEndValue_=this.indexEndValue_,a.endNameSet_=this.endNameSet_,a.indexEndName_=this.indexEndName_,a.index_=this.index_,a.viewFrom_=this.viewFrom_,a}}function by(d,b,c){let a=d.copy();return a.startSet_=!0,void 0===b&&(b=null),a.indexStartValue_=b,null!=c?(a.startNameSet_=!0,a.indexStartName_=c):(a.startNameSet_=!1,a.indexStartName_=""),a}function bz(d,b,c){let a=d.copy();return a.endSet_=!0,void 0===b&&(b=null),a.indexEndValue_=b,void 0!==c?(a.endNameSet_=!0,a.indexEndName_=c):(a.endNameSet_=!1,a.indexEndName_=""),a}function bA(b,c){let a=b.copy();return a.index_=c,a}function bB(a){let b={};if(a.isDefault())return b;let c;return a.index_===bd?c="$priority":a.index_===bm?c="$value":a.index_===a6?c="$key":((0,l.hu)(a.index_ instanceof bl,"Unrecognized index type!"),c=a.index_.toString()),b.orderBy=(0,l.Pz)(c),a.startSet_&&(b.startAt=(0,l.Pz)(a.indexStartValue_),a.startNameSet_&&(b.startAt+=","+(0,l.Pz)(a.indexStartName_))),a.endSet_&&(b.endAt=(0,l.Pz)(a.indexEndValue_),a.endNameSet_&&(b.endAt+=","+(0,l.Pz)(a.indexEndName_))),a.limitSet_&&(a.isViewFromLeft()?b.limitToFirst=a.limit_:b.limitToLast=a.limit_),b}function bC(a){let b={};if(a.startSet_&&(b.sp=a.indexStartValue_,a.startNameSet_&&(b.sn=a.indexStartName_)),a.endSet_&&(b.ep=a.indexEndValue_,a.endNameSet_&&(b.en=a.indexEndName_)),a.limitSet_){b.l=a.limit_;let c=a.viewFrom_;""===c&&(c=a.isViewFromLeft()?"l":"r"),b.vf=c}return a.index_!==bd&&(b.i=a.index_.toString()),b}
class bD extends r{constructor(a,b,c,d){super(),this.repoInfo_=a,this.onDataUpdate_=b,this.authTokenProvider_=c,this.appCheckTokenProvider_=d,this.log_=af("p:rest:"),this.listens_={}}reportStats(a){throw Error("Method not implemented.")}static getListenId_(a,b){return void 0!==b?"tag$"+b:((0,l.hu)(a._queryParams.isDefault(),"should have a tag if it's not a default query."),a._path.toString())}listen(a,g,c,h){let b=a._path.toString();this.log_("Listen called for "+b+" "+a._queryIdentifier);let d=bD.getListenId_(a,c),e={};this.listens_[d]=e;let f=bB(a._queryParams);this.restRequest_(b+".json",f,(a,g)=>{let f=g;if(404===a&&(f=null,a=null),null===a&&this.onDataUpdate_(b,f,!1,c),(0,l.DV)(this.listens_,d)===e){let i;h(a?401===a?"permission_denied":"rest_error:"+a:"ok",null)}})}unlisten(a,b){let c=bD.getListenId_(a,b);delete this.listens_[c]}get(a){let b=bB(a._queryParams),c=a._path.toString(),d=new l.BH;return this.restRequest_(c+".json",b,(b,e)=>{let a=e;404===b&&(a=null,b=null),null===b?(this.onDataUpdate_(c,a,!1,null),d.resolve(a)):d.reject(Error(a))}),d.promise}refreshAuthToken(a){}restRequest_(b,a={},c){return a.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([d,e])=>{d&&d.accessToken&&(a.auth=d.accessToken),e&&e.token&&(a.ac=e.token);let g=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+b+"?ns="+this.repoInfo_.namespace+(0,l.xO)(a);this.log_("Sending REST request for "+g);let f=new XMLHttpRequest;f.onreadystatechange=()=>{if(c&&4===f.readyState){this.log_("REST Response for "+g+" received. status:",f.status,"response:",f.responseText);let a=null;if(f.status>=200&&f.status<300){try{a=(0,l.cI)(f.responseText)}catch(b){ai("Failed to parse JSON response for "+g+": "+f.responseText)}c(null,a)}else 401!==f.status&&404!==f.status&&ai("Got unsuccessful REST response for "+g+" Status: "+f.status),c(f.status);c=null}},f.open("GET",g,!0),f.send()})}}
class bE{constructor(){this.rootNode_=e.EMPTY_NODE}getNode(a){return this.rootNode_.getChild(a)}updateSnapshot(a,b){this.rootNode_=this.rootNode_.updateChild(a,b)}}
function bF(){return{value:null,children:new Map}}function bG(a,b,c){if(aY(b))a.value=c,a.children.clear();else if(null!==a.value)a.value=a.value.updateChild(b,c);else{let d=aR(b);a.children.has(d)||a.children.set(d,bF());let e=a.children.get(d);b=aT(b),bG(e,b,c)}}function bH(a,b){if(aY(b))return a.value=null,a.children.clear(),!0;if(null!==a.value){if(a.value.isLeafNode())return!1;{let d=a.value;return a.value=null,d.forEachChild(bd,(b,c)=>{bG(a,new aP(b),c)}),bH(a,b)}}if(!(a.children.size>0))return!0;{let c=aR(b);if(b=aT(b),a.children.has(c)){let e=bH(a.children.get(c),b);e&&a.children.delete(c)}return 0===a.children.size}}function bI(a,b,c){null!==a.value?c(b,a.value):bJ(a,(a,d)=>{let e=new aP(b.toString()+"/"+a);bI(d,e,c)})}function bJ(a,b){a.children.forEach((a,c)=>{b(c,a)})}class bK{constructor(a,b){this.server_=b,this.statsToReport_={},this.statsListener_=new
class{constructor(a){this.collection_=a,this.last_=null}get(){let a=this.collection_.get(),b=Object.assign({},a);return this.last_&&aq(this.last_,(a,c)=>{b[a]=b[a]-c}),this.last_=a,b}}(a),aw(this.reportStats_.bind(this),Math.floor(1e4+2e4*Math.random()))}reportStats_(){let a=this.statsListener_.get(),b={},c=!1;aq(a,(a,d)=>{d>0&&(0,l.r3)(this.statsToReport_,a)&&(b[a]=d,c=!0)}),c&&this.server_.reportStats(b),aw(this.reportStats_.bind(this),Math.floor(2*Math.random()*3e5))}}function bL(){return{fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}function bM(){return{fromUser:!1,fromServer:!0,queryId:null,tagged:!1}}function bN(a){return{fromUser:!1,fromServer:!0,queryId:a,tagged:!0}}(a=k||(k={}))[a.OVERWRITE=0]="OVERWRITE",a[a.MERGE=1]="MERGE",a[a.ACK_USER_WRITE=2]="ACK_USER_WRITE",a[a.LISTEN_COMPLETE=3]="LISTEN_COMPLETE";class bO{constructor(a,b,c){this.path=a,this.affectedTree=b,this.revert=c,this.type=k.ACK_USER_WRITE,this.source=bL()}operationForChild(a){if(!aY(this.path))return(0,l.hu)(aR(this.path)===a,"operationForChild called for unrelated child."),new bO(aT(this.path),this.affectedTree,this.revert);if(null!=this.affectedTree.value)return(0,l.hu)(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{let b=this.affectedTree.subtree(new aP(a));return new bO(aQ(),b,this.revert)}}}
class bP{constructor(a,b){this.source=a,this.path=b,this.type=k.LISTEN_COMPLETE}operationForChild(a){return aY(this.path)?new bP(this.source,aQ()):new bP(this.source,aT(this.path))}}
class bQ{constructor(a,b,c){this.source=a,this.path=b,this.snap=c,this.type=k.OVERWRITE}operationForChild(a){return aY(this.path)?new bQ(this.source,aQ(),this.snap.getImmediateChild(a)):new bQ(this.source,aT(this.path),this.snap)}}
class bR{constructor(a,b,c){this.source=a,this.path=b,this.children=c,this.type=k.MERGE}operationForChild(b){if(!aY(this.path))return(0,l.hu)(aR(this.path)===b,"Can't get a merge for a child not on the path of the operation"),new bR(this.source,aT(this.path),this.children);{let a=this.children.subtree(new aP(b));return a.isEmpty()?null:a.value?new bQ(this.source,aQ(),a.value):new bR(this.source,aQ(),a)}}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}
class bS{constructor(a,b,c){this.node_=a,this.fullyInitialized_=b,this.filtered_=c}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(a){if(aY(a))return this.isFullyInitialized()&&!this.filtered_;let b=aR(a);return this.isCompleteForChild(b)}isCompleteForChild(a){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(a)}getNode(){return this.node_}}function bT(c,d,e,b,f,g){let a=b.filter(a=>a.type===e);a.sort((a,b)=>bV(c,a,b)),a.forEach(a=>{let b=bU(c,a,g);f.forEach(e=>{e.respondsTo(a.type)&&d.push(e.createEvent(b,c.query_))})})}function bU(b,a,c){return"value"===a.type||"child_removed"===a.type||(a.prevName=c.getPredecessorChildName(a.childName,a.snapshotNode,b.index_)),a}function bV(c,a,b){if(null==a.childName||null==b.childName)throw(0,l.g5)("Should only compare child_ events.");let d=new f(a.childName,a.snapshotNode),e=new f(b.childName,b.snapshotNode);return c.index_.compare(d,e)}
function bW(a,b){return{eventCache:a,serverCache:b}}function bX(a,b,c,d){return bW(new bS(b,c,d),a.serverCache)}function bY(a,b,c,d){return bW(a.eventCache,new bS(b,c,d))}function bZ(a){return a.eventCache.isFullyInitialized()?a.eventCache.getNode():null}function b$(a){return a.serverCache.isFullyInitialized()?a.serverCache.getNode():null}
let b_;class b0{constructor(a,b=(b_||(b_=new M(function(a,b){return a===b?0:a<b?-1:1})),b_)){this.value=a,this.children=b}static fromObject(a){let b=new b0(null);return aq(a,(a,c)=>{b=b.set(new aP(a),c)}),b}isEmpty(){return null===this.value&&this.children.isEmpty()}findRootMostMatchingPathAndValue(a,c){if(null!=this.value&&c(this.value))return{path:aQ(),value:this.value};if(aY(a))return null;{let d=aR(a),e=this.children.get(d);if(null===e)return null;{let b=e.findRootMostMatchingPathAndValue(aT(a),c);if(null==b)return null;{let f=aX(new aP(d),b.path);return{path:f,value:b.value}}}}}findRootMostValueAndPath(a){return this.findRootMostMatchingPathAndValue(a,()=>!0)}subtree(a){if(aY(a))return this;{let c=aR(a),b=this.children.get(c);return null!==b?b.subtree(aT(a)):new b0(null)}}set(a,b){if(aY(a))return new b0(b,this.children);{let c=aR(a),d=this.children.get(c)||new b0(null),e=d.set(aT(a),b),f=this.children.insert(c,e);return new b0(this.value,f)}}remove(a){if(aY(a))return this.children.isEmpty()?new b0(null):new b0(null,this.children);{let b=aR(a),d=this.children.get(b);if(!d)return this;{let e=d.remove(aT(a)),c;return(c=e.isEmpty()?this.children.remove(b):this.children.insert(b,e),null===this.value&&c.isEmpty())?new b0(null):new b0(this.value,c)}}}get(a){if(aY(a))return this.value;{let c=aR(a),b=this.children.get(c);return b?b.get(aT(a)):null}}setTree(a,c){if(aY(a))return c;{let b=aR(a),f=this.children.get(b)||new b0(null),d=f.setTree(aT(a),c),e;return e=d.isEmpty()?this.children.remove(b):this.children.insert(b,d),new b0(this.value,e)}}fold(a){return this.fold_(aQ(),a)}fold_(a,b){let c={};return this.children.inorderTraversal((d,e)=>{c[d]=e.fold_(aX(a,d),b)}),b(a,this.value,c)}findOnPath(a,b){return this.findOnPath_(a,aQ(),b)}findOnPath_(a,b,c){let d=!!this.value&&c(b,this.value);if(d)return d;if(aY(a))return null;{let e=aR(a),f=this.children.get(e);return f?f.findOnPath_(aT(a),aX(b,e),c):null}}foreachOnPath(a,b){return this.foreachOnPath_(a,aQ(),b)}foreachOnPath_(a,b,c){if(aY(a))return this;{this.value&&c(b,this.value);let d=aR(a),e=this.children.get(d);return e?e.foreachOnPath_(aT(a),aX(b,d),c):new b0(null)}}foreach(a){this.foreach_(aQ(),a)}foreach_(a,b){this.children.inorderTraversal((c,d)=>{d.foreach_(aX(a,c),b)}),this.value&&b(a,this.value)}foreachChild(a){this.children.inorderTraversal((c,b)=>{b.value&&a(c,b.value)})}}
class b1{constructor(a){this.writeTree_=a}static empty(){return new b1(new b0(null))}}function b2(b,a,c){if(aY(a))return new b1(new b0(c));{let d=b.writeTree_.findRootMostValueAndPath(a);if(null!=d){let f=d.path,e=d.value,g=aZ(f,a);return e=e.updateChild(g,c),new b1(b.writeTree_.set(f,e))}{let h=new b0(c),i=b.writeTree_.setTree(a,h);return new b1(i)}}}function b3(a,d,b){let c=a;return aq(b,(a,b)=>{c=b2(c,aX(d,a),b)}),c}function b4(b,a){if(aY(a))return b1.empty();{let c=b.writeTree_.setTree(a,new b0(null));return new b1(c)}}function b5(a,b){return null!=b6(a,b)}function b6(b,c){let a=b.writeTree_.findRootMostValueAndPath(c);return null!=a?b.writeTree_.get(a.path).getChild(aZ(a.path,c)):null}function b7(b){let c=[],a=b.writeTree_.value;return null!=a?a.isLeafNode()||a.forEachChild(bd,(a,b)=>{c.push(new f(a,b))}):b.writeTree_.children.inorderTraversal((b,a)=>{null!=a.value&&c.push(new f(b,a.value))}),c}function b8(a,b){if(aY(b))return a;{let c=b6(a,b);return new b1(null!=c?new b0(c):a.writeTree_.subtree(b))}}function b9(a){return a.writeTree_.isEmpty()}function ca(a,b){return cb(aQ(),a.writeTree_,b)}function cb(b,c,a){if(null!=c.value)return a.updateChild(b,c.value);{let d=null;return c.children.inorderTraversal((e,c)=>{".priority"===e?((0,l.hu)(null!==c.value,"Priority writes must always be leaf nodes"),d=c.value):a=cb(aX(b,e),c,a)}),a.getChild(b).isEmpty()||null===d||(a=a.updateChild(aX(b,".priority"),d)),a}}
function cc(a,b){return cn(b,a)}function cd(a,b){if(a.snap)return a0(a.path,b);for(let c in a.children)if(a.children.hasOwnProperty(c)&&a0(aX(a.path,c),b))return!0;return!1}function ce(a){return a.visible}function cf(g,i,d){let a=b1.empty();for(let f=0;f<g.length;++f){let c=g[f];if(i(c)){let e=c.path,b;if(c.snap)a0(d,e)?(b=aZ(d,e),a=b2(a,b,c.snap)):a0(e,d)&&(b=aZ(e,d),a=b2(a,aQ(),c.snap.getChild(b)));else if(c.children){if(a0(d,e))b=aZ(d,e),a=b3(a,b,c.children);else if(a0(e,d)){if(b=aZ(e,d),aY(b))a=b3(a,aQ(),c.children);else{let h=(0,l.DV)(c.children,aR(b));if(h){let j=h.getChild(aT(b));a=b2(a,aQ(),j)}}}}else throw(0,l.g5)("WriteRecord should have .snap or .children")}}return a}function cg(b,c,a,i,d){if(i||d){let g=b8(b.visibleWrites,c);if(!d&&b9(g))return a;if(!d&&null==a&&!b5(g,aQ()))return null;{let j=function(a){return(a.visible||d)&&(!i||!~i.indexOf(a.writeId))&&(a0(a.path,c)||a0(c,a.path))},k=cf(b.allWrites,j,c),l=a||e.EMPTY_NODE;return ca(k,l)}}{let h=b6(b.visibleWrites,c);if(null!=h)return h;{let f=b8(b.visibleWrites,c);if(b9(f))return a;if(null==a&&!b5(f,aQ()))return null;{let m=a||e.EMPTY_NODE;return ca(f,m)}}}}function ch(a,b,c,d){return cg(a.writeTree,a.treePath,b,c,d)}function ci(a,b){return function(a,b,f){let c=e.EMPTY_NODE,d=b6(a.visibleWrites,b);if(d)return d.isLeafNode()||d.forEachChild(bd,(a,b)=>{c=c.updateImmediateChild(a,b)}),c;if(f){let g=b8(a.visibleWrites,b);return f.forEachChild(bd,(a,b)=>{let d=ca(b8(g,new aP(a)),b);c=c.updateImmediateChild(a,d)}),b7(g).forEach(a=>{c=c.updateImmediateChild(a.name,a.node)}),c}{let h=b8(a.visibleWrites,b);return b7(h).forEach(a=>{c=c.updateImmediateChild(a.name,a.node)}),c}}(a.writeTree,a.treePath,b)}function cj(a,b,c,d){return function(c,f,a,g,b){(0,l.hu)(g||b,"Either existingEventSnap or existingServerSnap must exist");let d=aX(f,a);if(b5(c.visibleWrites,d))return null;{let e=b8(c.visibleWrites,d);return b9(e)?b.getChild(a):ca(e,b.getChild(a))}}(a.writeTree,a.treePath,b,c,d)}function ck(a,d){var b,c;return b=a.writeTree,c=aX(a.treePath,d),b6(b.visibleWrites,c)}function cl(a,b,c){return function(b,f,a,c){let d=aX(f,a),e=b6(b.visibleWrites,d);if(null!=e)return e;if(!c.isCompleteForChild(a))return null;{let g=b8(b.visibleWrites,d);return ca(g,c.getNode().getImmediateChild(a))}}(a.writeTree,a.treePath,b,c)}function cm(a,b){return cn(aX(a.treePath,b),a.writeTree)}function cn(a,b){return{treePath:a,writeTree:b}}
class co{constructor(){this.changeMap=new Map}trackChildChange(c){let b=c.type,a=c.childName;(0,l.hu)("child_added"===b||"child_changed"===b||"child_removed"===b,"Only child changes supported for tracking"),(0,l.hu)(".priority"!==a,"Only non-priority child changes can be tracked.");let d=this.changeMap.get(a);if(d){let e=d.type;if("child_added"===b&&"child_removed"===e)this.changeMap.set(a,bu(a,c.snapshotNode,d.snapshotNode));else if("child_removed"===b&&"child_added"===e)this.changeMap.delete(a);else if("child_removed"===b&&"child_changed"===e)this.changeMap.set(a,bt(a,d.oldSnap));else if("child_changed"===b&&"child_added"===e)this.changeMap.set(a,bs(a,c.snapshotNode));else if("child_changed"===b&&"child_changed"===e)this.changeMap.set(a,bu(a,c.snapshotNode,d.oldSnap));else throw(0,l.g5)("Illegal combination of changes: "+c+" occurred after "+d)}else this.changeMap.set(a,c)}getChanges(){return Array.from(this.changeMap.values())}}let cp=new
class{getCompleteChild(a){return null}getChildAfterChild(a,b,c){return null}};class cq{constructor(a,b,c=null){this.writes_=a,this.viewCache_=b,this.optCompleteServerCache_=c}getCompleteChild(a){let b=this.viewCache_.eventCache;if(b.isCompleteForChild(a))return b.getNode().getImmediateChild(a);{let c=null!=this.optCompleteServerCache_?new bS(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return cl(this.writes_,a,c)}}getChildAfterChild(g,h,i){var a,b,c,k,d,e;let j=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:b$(this.viewCache_),f=(a=this.writes_,b=j,c=h,d=i,e=g,function(j,k,f,d,n,l,b){let a,g=b8(j.visibleWrites,k),h=b6(g,aQ());if(null!=h)a=h;else{if(null==f)return[];a=ca(g,f)}if((a=a.withIndex(b)).isEmpty()||a.isLeafNode())return[];{let e=[],m=b.getCompare(),i=l?a.getReverseIteratorFrom(d,b):a.getIteratorFrom(d,b),c=i.getNext();for(;c&&e.length<1;)0!==m(c,d)&&e.push(c),c=i.getNext();return e}}(a.writeTree,a.treePath,b,c,1,d,e));return 0===f.length?null:f[0]}}function cr(g,a,c,d,r,k){let b=a.eventCache;if(null!=ck(d,c))return a;{let h,i;if(aY(c)){if((0,l.hu)(a.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),a.serverCache.isFiltered()){let m=b$(a),s=m instanceof e?m:e.EMPTY_NODE,t=ci(d,s);h=g.filter.updateFullNode(a.eventCache.getNode(),t,k)}else{let u=ch(d,b$(a));h=g.filter.updateFullNode(a.eventCache.getNode(),u,k)}}else{let f=aR(c);if(".priority"===f){(0,l.hu)(1===aS(c),"Can't have a priority with additional path components");let n=b.getNode();i=a.serverCache.getNode();let o=cj(d,c,n,i);h=null!=o?g.filter.updatePriority(n,o):b.getNode()}else{let p=aT(c),j;if(b.isCompleteForChild(f)){i=a.serverCache.getNode();let q=cj(d,c,b.getNode(),i);j=null!=q?b.getNode().getImmediateChild(f).updateChild(p,q):b.getNode().getImmediateChild(f)}else j=cl(d,f,a.serverCache);h=null!=j?g.filter.updateChild(b.getNode(),f,j,p,r,k):b.getNode()}}return bX(a,h,b.isFullyInitialized()||aY(c),g.filter.filtersNodes())}}function cs(e,f,b,g,i,m,n,o){let a=f.serverCache,d,c=n?e.filter:e.filter.getIndexedFilter();if(aY(b))d=c.updateFullNode(a.getNode(),g,null);else if(c.filtersNodes()&&!a.isFiltered()){let p=a.getNode().updateChild(b,g);d=c.updateFullNode(a.getNode(),p,null)}else{let h=aR(b);if(!a.isCompleteForPath(b)&&aS(b)>1)return f;let j=aT(b),q=a.getNode().getImmediateChild(h),k=q.updateChild(j,g);d=".priority"===h?c.updatePriority(a.getNode(),k):c.updateChild(a.getNode(),h,k,j,cp,null)}let l=bY(f,d,a.isFullyInitialized()||aY(b),c.filtersNodes()),r=new cq(i,l,m);return cr(e,l,b,i,r,o)}function ct(b,a,l,g,o,p,m){let c=a.eventCache,d,h,n=new cq(o,a,p);if(aY(l))h=b.filter.updateFullNode(a.eventCache.getNode(),g,m),d=bX(a,h,!0,b.filter.filtersNodes());else{let i=aR(l);if(".priority"===i)h=b.filter.updatePriority(a.eventCache.getNode(),g),d=bX(a,h,c.isFullyInitialized(),c.isFiltered());else{let f=aT(l),q=c.getNode().getImmediateChild(i),j;if(aY(f))j=g;else{let k=n.getCompleteChild(i);j=null!=k?".priority"===aU(f)&&k.getChild(aW(f)).isEmpty()?k:k.updateChild(f,g):e.EMPTY_NODE}if(q.equals(j))d=a;else{let r=b.filter.updateChild(c.getNode(),i,j,f,n,m);d=bX(a,r,c.isFullyInitialized(),b.filter.filtersNodes())}}}return d}function cu(a,b){return a.eventCache.isCompleteForChild(b)}function cv(c,a,b){return b.foreach((b,c)=>{a=a.updateChild(b,c)}),a}function cw(f,a,c,d,g,h,i,j){if(a.serverCache.getNode().isEmpty()&&!a.serverCache.isFullyInitialized())return a;let e=a,b;b=aY(c)?d:new b0(null).setTree(c,d);let k=a.serverCache.getNode();return b.children.inorderTraversal((b,c)=>{if(k.hasChild(b)){let d=a.serverCache.getNode().getImmediateChild(b),l=cv(f,d,c);e=cs(f,e,new aP(b),l,g,h,i,j)}}),b.children.inorderTraversal((b,c)=>{let d=!a.serverCache.isCompleteForChild(b)&&null===c.value;if(!k.hasChild(b)&&!d){let l=a.serverCache.getNode().getImmediateChild(b),m=cv(f,l,c);e=cs(f,e,new aP(b),m,g,h,i,j)}}),e}
class cx{constructor(k,c){var a,d;this.query_=k,this.eventRegistrations_=[];let g=this.query_._queryParams,h=new bv(g.getIndex()),b=(a=g).loadsAllData()?new bv(a.getIndex()):a.hasLimit()?new
class a{constructor(a){this.rangedFilter_=new bw(a),this.index_=a.getIndex(),this.limit_=a.getLimit(),this.reverse_=!a.isViewFromLeft()}updateChild(a,c,b,h,d,g){return(this.rangedFilter_.matches(new f(c,b))||(b=e.EMPTY_NODE),a.getImmediateChild(c).equals(b))?a:a.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(a,c,b,h,d,g):this.fullLimitUpdateChild_(a,c,b,d,g)}updateFullNode(n,b,o){let a;if(b.isLeafNode()||b.isEmpty())a=e.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<b.numChildren()&&b.isIndexed(this.index_)){a=e.EMPTY_NODE.withIndex(this.index_);let g;g=this.reverse_?b.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):b.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let l=0;for(;g.hasNext()&&l<this.limit_;){let c=g.getNext(),q;if(this.reverse_?0>=this.index_.compare(this.rangedFilter_.getStartPost(),c):0>=this.index_.compare(c,this.rangedFilter_.getEndPost()))a=a.updateImmediateChild(c.name,c.node),l++;else break}}else{a=(a=b.withIndex(this.index_)).updatePriority(e.EMPTY_NODE);let h,i,d,f;if(this.reverse_){f=a.getReverseIterator(this.index_),h=this.rangedFilter_.getEndPost(),i=this.rangedFilter_.getStartPost();let r=this.index_.getCompare();d=(a,b)=>r(b,a)}else f=a.getIterator(this.index_),h=this.rangedFilter_.getStartPost(),i=this.rangedFilter_.getEndPost(),d=this.index_.getCompare();let m=0,j=!1;for(;f.hasNext();){let k=f.getNext();!j&&0>=d(h,k)&&(j=!0);let p=j&&m<this.limit_&&0>=d(k,i);p?m++:a=a.updateImmediateChild(k.name,e.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(n,a,o)}updatePriority(a,b){return a}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(i,b,g,m,c){let j;if(this.reverse_){let t=this.index_.getCompare();j=(a,b)=>t(b,a)}else j=this.index_.getCompare();let d=i;(0,l.hu)(d.numChildren()===this.limit_,"");let k=new f(b,g),h=this.reverse_?d.getFirstChild(this.index_):d.getLastChild(this.index_),n=this.rangedFilter_.matches(k);if(d.hasChild(b)){let o=d.getImmediateChild(b),a=m.getChildAfterChild(this.index_,h,this.reverse_);for(;null!=a&&(a.name===b||d.hasChild(a.name));)a=m.getChildAfterChild(this.index_,a,this.reverse_);let q=null==a?1:j(a,k),r=n&&!g.isEmpty()&&q>=0;if(r)return null!=c&&c.trackChildChange(bu(b,g,o)),d.updateImmediateChild(b,g);{null!=c&&c.trackChildChange(bt(b,o));let p=d.updateImmediateChild(b,e.EMPTY_NODE),s=null!=a&&this.rangedFilter_.matches(a);return s?(null!=c&&c.trackChildChange(bs(a.name,a.node)),p.updateImmediateChild(a.name,a.node)):p}}return g.isEmpty()?i:n?j(h,k)>=0?(null!=c&&(c.trackChildChange(bt(h.name,h.node)),c.trackChildChange(bs(b,g))),d.updateImmediateChild(b,g).updateImmediateChild(h.name,e.EMPTY_NODE)):i:i}}(a):new bw(a);this.processor_=(d=b,{filter:d});let i=c.serverCache,j=c.eventCache,m=h.updateFullNode(e.EMPTY_NODE,i.getNode(),null),n=b.updateFullNode(e.EMPTY_NODE,j.getNode(),null),o=new bS(m,i.isFullyInitialized(),h.filtersNodes()),p=new bS(n,j.isFullyInitialized(),b.filtersNodes());this.viewCache_=bW(p,o),this.eventGenerator_=new
class{constructor(a){this.query_=a,this.index_=this.query_._queryParams.getIndex()}}(this.query_)}get query(){return this.query_}}function cy(c,a){let b=b$(c.viewCache_);return b&&(c.query._queryParams.loadsAllData()||!aY(a)&&!b.getImmediateChild(aR(a)).isEmpty())?b.getChild(a):null}function cz(a){return 0===a.eventRegistrations_.length}function cA(a,b,f){let g=[];if(f){(0,l.hu)(null==b,"A cancel should cancel all event registrations.");let h=a.query._path;a.eventRegistrations_.forEach(b=>{let a=b.createCancelEvent(f,h);a&&g.push(a)})}if(b){let c=[];for(let d=0;d<a.eventRegistrations_.length;++d){let e=a.eventRegistrations_[d];if(e.matches(b)){if(b.hasAnyCallback()){c=c.concat(a.eventRegistrations_.slice(d+1));break}}else c.push(e)}a.eventRegistrations_=c}else a.eventRegistrations_=[];return g}function cB(a,c,h,i){var d,f;c.type===k.MERGE&&null!==c.source.queryId&&((0,l.hu)(b$(a.viewCache_),"We should always have a full cache before handling merges"),(0,l.hu)(bZ(a.viewCache_),"Missing event cache, even though we have a server cache"));let g=a.viewCache_,b=function(g,a,b,h,j){let c=new co,d,m;if(b.type===k.OVERWRITE){let f=b;f.source.fromUser?d=ct(g,a,f.path,f.snap,h,j,c):((0,l.hu)(f.source.fromServer,"Unknown source."),m=f.source.tagged||a.serverCache.isFiltered()&&!aY(f.path),d=cs(g,a,f.path,f.snap,h,j,m,c))}else if(b.type===k.MERGE){var s,p,t,o,u,v,w;let i=b,q;i.source.fromUser?d=(s=g,p=a,t=i.path,o=i.children,u=h,v=j,w=c,q=p,o.foreach((b,c)=>{let a=aX(t,b);cu(p,aR(a))&&(q=ct(s,q,a,c,u,v,w))}),o.foreach((b,c)=>{let a=aX(t,b);cu(p,aR(a))||(q=ct(s,q,a,c,u,v,w))}),q):((0,l.hu)(i.source.fromServer,"Unknown source."),m=i.source.tagged||a.serverCache.isFiltered(),d=cw(g,a,i.path,i.children,h,j,m,c))}else if(b.type===k.ACK_USER_WRITE){let n=b;d=n.revert?function q(f,a,c,b,p,i){let j;if(null!=ck(b,c))return a;{let n=new cq(b,a,p),g=a.eventCache.getNode(),h;if(aY(c)||".priority"===aR(c)){let m;if(a.serverCache.isFullyInitialized())m=ch(b,b$(a));else{let o=a.serverCache.getNode();(0,l.hu)(o instanceof e,"serverChildren would be complete if leaf node"),m=ci(b,o)}h=f.filter.updateFullNode(g,m,i)}else{let d=aR(c),k=cl(b,d,a.serverCache);null==k&&a.serverCache.isCompleteForChild(d)&&(k=g.getImmediateChild(d)),(h=null!=k?f.filter.updateChild(g,d,k,aT(c),n,i):a.eventCache.getNode().hasChild(d)?f.filter.updateChild(g,d,e.EMPTY_NODE,aT(c),n,i):g).isEmpty()&&a.serverCache.isFullyInitialized()&&(j=ch(b,b$(a))).isLeafNode()&&(h=f.filter.updateFullNode(h,j,i))}return j=a.serverCache.isFullyInitialized()||null!=ck(b,aQ()),bX(a,h,j,f.filter.filtersNodes())}}(g,a,n.path,h,j,c):function l(e,b,a,i,c,f,g){if(null!=ck(c,a))return b;let h=b.serverCache.isFiltered(),d=b.serverCache;if(null!=i.value){if(aY(a)&&d.isFullyInitialized()||d.isCompleteForPath(a))return cs(e,b,a,d.getNode().getChild(a),c,f,h,g);if(!aY(a))return b;{let j=new b0(null);return d.getNode().forEachChild(a6,(a,b)=>{j=j.set(new aP(a),b)}),cw(e,b,a,j,c,f,h,g)}}{let k=new b0(null);return i.foreach((b,e)=>{let c=aX(a,b);d.isCompleteForPath(c)&&(k=k.set(b,d.getNode().getChild(c)))}),cw(e,b,a,k,c,f,h,g)}}(g,a,n.path,n.affectedTree,h,j,c)}else if(b.type===k.LISTEN_COMPLETE)d=function h(d,b,c,e,f){let a=b.serverCache,g=bY(b,a.getNode(),a.isFullyInitialized()||aY(c),a.isFiltered());return cr(d,g,c,e,cp,f)}(g,a,b.path,h,c);else throw(0,l.g5)("Unknown operation type: "+b.type);let r=c.getChanges();return function g(b,c,d){let a=c.eventCache;if(a.isFullyInitialized()){let f=a.getNode().isLeafNode()||a.getNode().isEmpty(),e=bZ(b);!(d.length>0)&&b.eventCache.isFullyInitialized()&&(!f||a.getNode().equals(e))&&a.getNode().getPriority().equals(e.getPriority())||d.push(br(bZ(c)))}}(a,d,r),{viewCache:d,changes:r}}(a.processor_,g,c,h,i);return d=a.processor_,f=b.viewCache,(0,l.hu)(f.eventCache.getNode().isIndexed(d.filter.getIndex()),"Event snap not indexed"),(0,l.hu)(f.serverCache.getNode().isIndexed(d.filter.getIndex()),"Server snap not indexed"),(0,l.hu)(b.viewCache.serverCache.isFullyInitialized()||!g.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),a.viewCache_=b.viewCache,cC(a,b.changes,b.viewCache.eventCache.getNode(),null)}function cC(a,c,d,b){let e=b?[b]:a.eventRegistrations_;return function(b,c,d,e){let a=[],f=[];return c.forEach(a=>{if("child_changed"===a.type&&b.index_.indexedValueChanged(a.oldSnap,a.snapshotNode)){var c,d;f.push((c=a.childName,d=a.snapshotNode,{type:"child_moved",snapshotNode:d,childName:c}))}}),bT(b,a,"child_removed",c,e,d),bT(b,a,"child_added",c,e,d),bT(b,a,"child_moved",f,e,d),bT(b,a,"child_changed",c,e,d),bT(b,a,"value",c,e,d),a}(a.eventGenerator_,c,d,e)}
let x;class cD{constructor(){this.views=new Map}}function cE(c,a,d,e){let f=a.source.queryId;if(null!==f){let g=c.views.get(f);return(0,l.hu)(null!=g,"SyncTree gave us an op for an invalid query."),cB(g,a,d,e)}{let b=[];for(let h of c.views.values())b=b.concat(cB(h,a,d,e));return b}}function cF(i,d,f,a,g){let j=d._queryIdentifier,h=i.views.get(j);if(!h){let b=ch(f,g?a:null),c=!1;b?c=!0:a instanceof e?(b=ci(f,a),c=!1):(b=e.EMPTY_NODE,c=!1);let k=bW(new bS(b,c,!1),new bS(a,g,!1));return new cx(d,k)}return h}function cG(c){let a=[];for(let b of c.views.values())b.query._queryParams.loadsAllData()||a.push(b);return a}function cH(b,c){let a=null;for(let d of b.views.values())a=a||cy(d,c);return a}function cI(a,b){let c=b._queryParams;if(c.loadsAllData())return cL(a);{let d=b._queryIdentifier;return a.views.get(d)}}function cJ(a,b){return null!=cI(a,b)}function cK(a){return null!=cL(a)}function cL(b){for(let a of b.views.values())if(a.query._queryParams.loadsAllData())return a;return null}
let y,cM=1;class cN{constructor(a){this.listenProvider_=a,this.syncPointTree_=new b0(null),this.pendingWriteTree_={visibleWrites:b1.empty(),allWrites:[],lastWriteId:-1},this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function cO(f,g,h,j,i){var a,d,e,c,b;return(a=f.pendingWriteTree_,d=g,e=h,c=j,b=i,(0,l.hu)(c>a.lastWriteId,"Stacking an older write on top of newer ones"),void 0===b&&(b=!0),a.allWrites.push({path:d,snap:e,writeId:c,visible:b}),b&&(a.visibleWrites=b2(a.visibleWrites,d,e)),a.lastWriteId=c,i)?cV(f,new bQ(bL(),g,h)):[]}function cP(a,d,e=!1){let b=function(b,d){for(let a=0;a<b.allWrites.length;a++){let c=b.allWrites[a];if(c.writeId===d)return c}return null}(a.pendingWriteTree_,d),f=function(a,j){let d=a.allWrites.findIndex(a=>a.writeId===j);(0,l.hu)(d>=0,"removeWrite called with nonexistent writeId.");let c=a.allWrites[d];a.allWrites.splice(d,1);let f=c.visible,h=!1,e=a.allWrites.length-1;for(;f&&e>=0;){let g=a.allWrites[e];g.visible&&(e>=d&&cd(g,c.path)?f=!1:a0(c.path,g.path)&&(h=!0)),e--}if(!f)return!1;if(h){var b;return(b=a).visibleWrites=cf(b.allWrites,ce,aQ()),b.allWrites.length>0?b.lastWriteId=b.allWrites[b.allWrites.length-1].writeId:b.lastWriteId=-1,!0}if(c.snap)a.visibleWrites=b4(a.visibleWrites,c.path);else{let i=c.children;aq(i,b=>{a.visibleWrites=b4(a.visibleWrites,aX(c.path,b))})}return!0}(a.pendingWriteTree_,d);if(!f)return[];{let c=new b0(null);return null!=b.snap?c=c.set(aQ(),!0):aq(b.children,a=>{c=c.set(new aP(a),!0)}),cV(a,new bO(b.path,c,e))}}function cQ(a,b,c){return cV(a,new bQ(bM(),b,c))}function cR(a,b,r,g,s=!1){let c=b._path,d=a.syncPointTree_.get(c),h=[];if(d&&("default"===b._queryIdentifier||cJ(d,b))){var t;let i=function(a,f,h,i){let g=f._queryIdentifier,d=[],b=[],j=cK(a);if("default"===g)for(let[k,e]of a.views.entries())b=b.concat(cA(e,h,i)),cz(e)&&(a.views.delete(k),e.query._queryParams.loadsAllData()||d.push(e.query));else{let c=a.views.get(g);c&&(b=b.concat(cA(c,h,i)),cz(c)&&(a.views.delete(g),c.query._queryParams.loadsAllData()||d.push(c.query)))}return j&&!cK(a)&&d.push(new((0,l.hu)(x,"Reference.ts has not been loaded"),x)(f._repo,f._path)),{removed:d,events:b}}(d,b,r,g);0===(t=d).views.size&&(a.syncPointTree_=a.syncPointTree_.remove(c));let e=i.removed;if(h=i.events,!s){let j=-1!==e.findIndex(a=>a._queryParams.loadsAllData()),k=a.syncPointTree_.findOnPath(c,(b,a)=>cK(a));if(j&&!k){let m=a.syncPointTree_.subtree(c);if(!m.isEmpty()){let n=c2(m);for(let f=0;f<n.length;++f){let o=n[f],p=o.query,q=cY(a,o);a.listenProvider_.startListening(c3(p),cZ(a,p),q.hashFn,q.onComplete)}}}if(!k&&e.length>0&&!g){if(j){let u=null;a.listenProvider_.stopListening(c3(b),u)}else e.forEach(b=>{let c=a.queryToTagMap.get(c$(b));a.listenProvider_.stopListening(c3(b),c)})}}c4(a,e)}return h}function cS(a,e,f,g){let b=c_(a,g);if(null==b)return[];{let c=c0(b),d=c.path,h=c.queryId,i=aZ(d,e),j=new bQ(bN(h),i,f);return c1(a,d,j)}}function cT(a,c,n,o=!1){let d=c._path,f=null,g=!1;a.syncPointTree_.foreachOnPath(d,(b,a)=>{let c=aZ(b,d);f=f||cH(a,c),g=g||cK(a)});let b=a.syncPointTree_.get(d);b?(g=g||cK(b),f=f||cH(b,aQ())):(b=new cD,a.syncPointTree_=a.syncPointTree_.set(d,b));let h;if(null!=f)h=!0;else{h=!1,f=e.EMPTY_NODE;let p=a.syncPointTree_.subtree(d);p.foreachChild((b,c)=>{let a=cH(c,aQ());a&&(f=f.updateImmediateChild(b,a))})}let k=cJ(b,c);if(!k&&!c._queryParams.loadsAllData()){let i=c$(c);(0,l.hu)(!a.queryToTagMap.has(i),"View does not exist, but we have a tag");let m=c5();a.queryToTagMap.set(i,m),a.tagToQueryMap.set(m,i)}let q=cc(a.pendingWriteTree_,d),j=function(a,b,d,e,f,g){let c=cF(a,b,e,f,g);return a.views.has(b._queryIdentifier)||a.views.set(b._queryIdentifier,c),!function(a,b){a.eventRegistrations_.push(b)}(c,d),function(b,d){let a=b.viewCache_.eventCache,c=[];if(!a.getNode().isLeafNode()){let e=a.getNode();e.forEachChild(bd,(a,b)=>{c.push(bs(a,b))})}return a.isFullyInitialized()&&c.push(br(a.getNode())),cC(b,c,a.getNode(),d)}(c,d)}(b,c,n,q,f,h);if(!k&&!g&&!o){let r=cI(b,c);j=j.concat(c6(a,c,r))}return j}function cU(a,b,c){let d=a.pendingWriteTree_,e=a.syncPointTree_.findOnPath(b,(c,d)=>{let e=aZ(c,b),a=cH(d,e);if(a)return a});return cg(d,b,e,c,!0)}function cV(a,b){return cW(b,a.syncPointTree_,null,cc(a.pendingWriteTree_,aQ()))}function cW(b,f,a,g){if(aY(b.path))return cX(b,f,a,g);{let d=f.get(aQ());null==a&&null!=d&&(a=cH(d,aQ()));let c=[],e=aR(b.path),h=b.operationForChild(e),i=f.children.get(e);if(i&&h){let j=a?a.getImmediateChild(e):null,k=cm(g,e);c=c.concat(cW(h,i,j,k))}return d&&(c=c.concat(cE(d,b,g,a))),c}}function cX(e,d,b,f){let a=d.get(aQ());null==b&&null!=a&&(b=cH(a,aQ()));let c=[];return d.children.inorderTraversal((a,g)=>{let h=b?b.getImmediateChild(a):null,i=cm(f,a),d=e.operationForChild(a);d&&(c=c.concat(cX(d,g,h,i)))}),a&&(c=c.concat(cE(a,e,f,b))),c}function cY(a,b){let c=b.query,d=cZ(a,c);return{hashFn(){var a;let c=(a=b).viewCache_.serverCache.getNode()||e.EMPTY_NODE;return c.hash()},onComplete(b){if("ok"===b){var e,f;return d?function(a,e,f){let b=c_(a,f);if(!b)return[];{let c=c0(b),d=c.path,g=c.queryId,h=aZ(d,e),i=new bP(bN(g),h);return c1(a,d,i)}}(a,c._path,d):(e=a,f=c._path,cV(e,new bP(bM(),f)))}{let g=function(a,d){let b="Unknown Error";"too_big"===a?b="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"===a?b="Client doesn't have permission to access the desired data.":"unavailable"===a&&(b="The service is unavailable");let c=Error(a+" at "+d._path.toString()+": "+b);return c.code=a.toUpperCase(),c}(b,c);return cR(a,c,null,g)}}}}function cZ(a,b){let c=c$(b);return a.queryToTagMap.get(c)}function c$(a){return a._path.toString()+"$"+a._queryIdentifier}function c_(a,b){return a.tagToQueryMap.get(b)}function c0(a){let b=a.indexOf("$");return(0,l.hu)(-1!==b&&b<a.length-1,"Bad queryKey."),{queryId:a.substr(b+1),path:new aP(a.substr(0,b))}}function c1(a,b,d){let c=a.syncPointTree_.get(b);(0,l.hu)(c,"Missing sync point for query tag that we're tracking");let e=cc(a.pendingWriteTree_,b);return cE(c,d,e,null)}function c2(a){return a.fold((e,a,c)=>{if(a&&cK(a)){let d=cL(a);return[d]}{let b=[];return a&&(b=cG(a)),aq(c,(c,a)=>{b=b.concat(a)}),b}})}function c3(a){return a._queryParams.loadsAllData()&&!a._queryParams.isDefault()?new((0,l.hu)(y,"Reference.ts has not been loaded"),y)(a._repo,a._path):a}function c4(a,c){for(let b=0;b<c.length;++b){let d=c[b];if(!d._queryParams.loadsAllData()){let e=c$(d),f=a.queryToTagMap.get(e);a.queryToTagMap.delete(e),a.tagToQueryMap.delete(f)}}}function c5(){return cM++}function c6(a,b,i){let j=b._path,d=cZ(a,b),e=cY(a,i),k=a.listenProvider_.startListening(c3(b),d,e.hashFn,e.onComplete),f=a.syncPointTree_.subtree(j);if(d)(0,l.hu)(!cK(f.value),"If we're adding a query, it shouldn't be shadowed");else{let g=f.fold((c,a,d)=>{if(!aY(c)&&a&&cK(a))return[cL(a).query];{let b=[];return a&&(b=b.concat(cG(a).map(a=>a.query))),aq(d,(c,a)=>{b=b.concat(a)}),b}});for(let c=0;c<g.length;++c){let h=g[c];a.listenProvider_.stopListening(c3(h),cZ(a,h))}}return k}
class c7{constructor(a){this.node_=a}getImmediateChild(a){let b=this.node_.getImmediateChild(a);return new c7(b)}node(){return this.node_}}class c8{constructor(a,b){this.syncTree_=a,this.path_=b}getImmediateChild(a){let b=aX(this.path_,a);return new c8(this.syncTree_,b)}node(){return cU(this.syncTree_,this.path_)}}let c9=function(a,b,c){return a&&"object"==typeof a?((0,l.hu)(".sv"in a,"Unexpected leaf node or priority contents"),"string"==typeof a[".sv"])?da(a[".sv"],b,c):"object"==typeof a[".sv"]?db(a[".sv"],b):void(0,l.hu)(!1,"Unexpected server value: "+JSON.stringify(a,null,2)):a},da=function(a,c,b){if("timestamp"===a)return b.timestamp;(0,l.hu)(!1,"Unexpected server value: "+a)},db=function(b,e,f){b.hasOwnProperty("increment")||(0,l.hu)(!1,"Unexpected server value: "+JSON.stringify(b,null,2));let a=b.increment;"number"!=typeof a&&(0,l.hu)(!1,"Unexpected increment value: "+a);let c=e.node();if((0,l.hu)(null!=c,"Expected ChildrenNode.EMPTY_NODE for nulls"),!c.isLeafNode())return a;let d=c.getValue();return"number"!=typeof d?a:d+a},dc=function(a,b,c,d){return de(b,new c8(c,a),d)},dd=function(a,b,c){return de(a,new c7(b),c)};function de(a,f,g){let i=a.getPriority().val(),b=c9(i,f.getImmediateChild(".priority"),g),c;if(a.isLeafNode()){let d=a,h=c9(d.getValue(),f,g);return h!==d.getValue()||b!==d.getPriority().val()?new w(h,Q(b)):a}{let e=a;return c=e,b!==e.getPriority().val()&&(c=c.updatePriority(new w(b))),e.forEachChild(bd,(a,b)=>{let d=de(b,f.getImmediateChild(a),g);d!==b&&(c=c.updateImmediateChild(a,d))}),c}}
class df{constructor(a="",b=null,c={children:{},childCount:0}){this.name=a,this.parent=b,this.node=c}}function dg(e,d){let a=d instanceof aP?d:new aP(d),b=e,c=aR(a);for(;null!==c;){let f=(0,l.DV)(b.node.children,c)||{children:{},childCount:0};b=new df(c,b,f),a=aT(a),c=aR(a)}return b}function dh(a){return a.node.value}function di(a,b){a.node.value=b,dn(a)}function dj(a){return a.node.childCount>0}function dk(a,b){aq(a.node.children,(c,d)=>{b(new df(c,a,d))})}function dl(a,b,c,d){c&&!d&&b(a),dk(a,a=>{dl(a,b,!0,d)}),c&&d&&b(a)}function dm(a){return new aP(null===a.parent?a.name:dm(a.parent)+"/"+a.name)}function dn(a){null!==a.parent&&dp(a.parent,a.name,a)}function dp(a,b,c){var d;let e=void 0===dh(d=c)&&!dj(d),f=(0,l.r3)(a.node.children,b);e&&f?(delete a.node.children[b],a.node.childCount--,dn(a)):e||f||(a.node.children[b]=c.node,a.node.childCount++,dn(a))}
let dq=/[\[\].#$\/\u0000-\u001F\u007F]/,dr=/[\[\].#$\u0000-\u001F\u007F]/,ds=function(a){return"string"==typeof a&&0!==a.length&&!dq.test(a)},dt=function(a){return"string"==typeof a&&0!==a.length&&!dr.test(a)},du=function(a){return null===a||"string"==typeof a||"number"==typeof a&&!ak(a)||a&&"object"==typeof a&&(0,l.r3)(a,".sv")},dv=function(b,a,c,d){(!d||void 0!==a)&&dw((0,l.gK)(b,"value"),a,c)},dw=function(b,a,d){let c=d instanceof aP?new a1(d,b):d;if(void 0===a)throw Error(b+"contains undefined "+a3(c));if("function"==typeof a)throw Error(b+"contains a function "+a3(c)+" with contents = "+a.toString());if(ak(a))throw Error(b+"contains "+a.toString()+" "+a3(c));if("string"==typeof a&&a.length>3495253.3333333335&&(0,l.ug)(a)>10485760)throw Error(b+"contains a string greater than 10485760 utf8 bytes "+a3(c)+" ('"+a.substring(0,50)+"...')");if(a&&"object"==typeof a){let e=!1,f=!1;if(aq(a,(a,h)=>{var d,g;if(".value"===a)e=!0;else if(".priority"!==a&&".sv"!==a&&(f=!0,!ds(a)))throw Error(b+" contains an invalid key ("+a+") "+a3(c)+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');d=c,g=a,d.parts_.length>0&&(d.byteLength_+=1),d.parts_.push(g),d.byteLength_+=(0,l.ug)(g),a2(d),dw(b,h,c),function(a){let b=a.parts_.pop();a.byteLength_-=(0,l.ug)(b),a.parts_.length>0&&(a.byteLength_-=1)}(c)}),e&&f)throw Error(b+' contains ".value" child '+a3(c)+" in addition to actual children.")}},dx=function(g,d){let a,b;for(a=0;a<d.length;a++){b=d[a];let e=aV(b);for(let c=0;c<e.length;c++)if(".priority"===e[c]&&c===e.length-1);else if(!ds(e[c]))throw Error(g+"contains an invalid key ("+e[c]+") in path "+b.toString()+'. Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"')}d.sort(a$);let f=null;for(a=0;a<d.length;a++){if(b=d[a],null!==f&&a0(f,b))throw Error(g+"contains a path "+f.toString()+" that is ancestor of another path "+b.toString());f=b}},dy=function(c,a,f,d){if(d&&void 0===a)return;let b=errorPrefix(c,"values");if(!(a&&"object"==typeof a)||Array.isArray(a))throw Error(b+" must be an object containing the children to replace.");let e=[];aq(a,(d,c)=>{let a=new aP(d);if(dw(b,c,aX(f,a)),".priority"===aU(a)&&!du(c))throw Error(b+"contains an invalid value for '"+a.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");e.push(a)}),dx(b,e)},dz=function(b,a,c){if(!c||void 0!==a){if(ak(a))throw Error(errorPrefix(b,"priority")+"is "+a.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!du(a))throw Error(errorPrefix(b,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},dA=function(b,c,a,d){if((!d||void 0!==a)&&!dt(a))throw Error((0,l.gK)(b,c)+'was an invalid path = "'+a+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"')},dB=function(b,c,a,d){a&&(a=a.replace(/^\/*\.info(\/|$)/,"/")),dA(b,c,a,d)},dC=function(a,b){if(".info"===aR(b))throw Error(a+" failed = Can't modify data under /.info/")},dD=function(d,a){var b;let c=a.path.toString();if("string"!=typeof a.repoInfo.host||0===a.repoInfo.host.length||!ds(a.repoInfo.namespace)&&"localhost"!==a.repoInfo.host.split(":")[0]||0!==c.length&&((b=c)&&(b=b.replace(/^\/*\.info(\/|$)/,"/")),!dt(b)))throw Error((0,l.gK)(d,"url")+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')};function dE(c,d){let a=null;for(let b=0;b<d.length;b++){let e=d[b],f=e.getPath();null===a||a_(f,a.path)||(c.eventLists_.push(a),a=null),null===a&&(a={events:[],path:f}),a.events.push(e)}a&&c.eventLists_.push(a)}function dF(a,c,b){dE(a,b),dH(a,a=>a_(a,c))}function dG(a,c,b){dE(a,b),dH(a,a=>a0(a,c)||a0(c,a))}function dH(a,e){a.recursionDepth_++;let c=!0;for(let b=0;b<a.eventLists_.length;b++){let d=a.eventLists_[b];if(d){let f=d.path;e(f)?(dI(a.eventLists_[b]),a.eventLists_[b]=null):c=!1}}c&&(a.eventLists_=[]),a.recursionDepth_--}function dI(b){for(let a=0;a<b.events.length;a++){let c=b.events[a];if(null!==c){b.events[a]=null;let d=c.getEventRunner();ab&&ae("event: "+c.toString()),au(d)}}}class dJ{constructor(a,b,c,d){this.repoInfo_=a,this.forceRestClient_=b,this.authTokenProvider_=c,this.appCheckProvider_=d,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new
class{constructor(){this.eventLists_=[],this.recursionDepth_=0}},this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=bF(),this.transactionQueueTree_=new df,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function dK(a){let b=a.infoData_.getNode(new aP(".info/serverTimeOffset")),c=b.val()||0;return new Date().getTime()+c}function dL(b){var a;return(a=a={timestamp:dK(b)}).timestamp=a.timestamp||new Date().getTime(),a}function dM(a,f,b,g,e){a.dataUpdateCount++;let c=new aP(f);b=a.interceptServerDataCallback_?a.interceptServerDataCallback_(f,b):b;let d=[];if(e){if(g){let i=(0,l.UI)(b,a=>Q(a));d=function(a,e,f,g){let b=c_(a,g);if(!b)return[];{let c=c0(b),d=c.path,h=c.queryId,i=aZ(d,e),j=b0.fromObject(f),k=new bR(bN(h),i,j);return c1(a,d,k)}}(a.serverSyncTree_,c,i,e)}else{let j=Q(b);d=cS(a.serverSyncTree_,c,j,e)}}else if(g){let k=(0,l.UI)(b,a=>Q(a));d=function(a,b,c){let d=b0.fromObject(c);return cV(a,new bR(bM(),b,d))}(a.serverSyncTree_,c,k)}else{let m=Q(b);d=cQ(a.serverSyncTree_,c,m)}let h=c;d.length>0&&(h=dY(a,c)),dG(a.eventQueue_,h,d)}function dN(a,b){dO(a,"connected",b),!1===b&&dQ(a)}function dO(a,d,e){let b=new aP("/.info/"+d),c=Q(e);a.infoData_.updateSnapshot(b,c);let f=cQ(a.infoSyncTree_,b,c);dG(a.eventQueue_,b,f)}function dP(a){return a.nextWriteId_++}function dQ(a){dT(a,"onDisconnectEvents");let d=dL(a),b=bF();bI(a.onDisconnect_,aQ(),(c,e)=>{let f=dc(c,e,a.serverSyncTree_,d);bG(b,c,f)});let c=[];bI(b,aQ(),(b,d)=>{c=c.concat(cQ(a.serverSyncTree_,b,d));let e=d2(a,b);dY(a,e)}),a.onDisconnect_=bF(),dG(a.eventQueue_,aQ(),c)}function dR(a,b,c,e){let d=Q(c);a.server_.onDisconnectPut(b.toString(),d.val(!0),(c,f)=>{"ok"===c&&bG(a.onDisconnect_,b,d),dU(a,e,c,f)})}function dS(b,a,c){let d;d=".info"===aR(a._path)?cR(b.infoSyncTree_,a,c):cR(b.serverSyncTree_,a,c),dF(b.eventQueue_,a._path,d)}function dT(a,...c){let b="";a.persistentConnection_&&(b=a.persistentConnection_.id+":"),ae(b,...c)}function dU(b,a,c,d){a&&au(()=>{if("ok"===c)a(null);else{let b=(c||"error").toUpperCase(),e=b;d&&(e+=": "+d);let f=Error(e);f.code=b,a(f)}})}function dV(a,b,c){return cU(a.serverSyncTree_,b,c)||e.EMPTY_NODE}function dW(b,a=b.transactionQueueTree_){if(a||d1(b,a),dh(a)){let c=d_(b,a);(0,l.hu)(c.length>0,"Sending zero length transaction queue");let d=c.every(a=>0===a.status);d&&dX(b,dm(a),c)}else dj(a)&&dk(a,a=>{dW(b,a)})}function dX(f,b,c){let h=c.map(a=>a.currentWriteId),g=dV(f,b,h),d=g,i=g.hash();for(let e=0;e<c.length;e++){let a=c[e];(0,l.hu)(0===a.status,"tryToSendTransactionQueue_: items in queue should all be run."),a.status=1,a.retryCount++;let j=aZ(b,a.path);d=d.updateChild(j,a.currentOutputSnapshotRaw)}let k=d.val(!0),m=b;f.server_.put(m.toString(),k,d=>{dT(f,"transaction put response",{path:m.toString(),status:d});let h=[];if("ok"===d){let i=[];for(let a=0;a<c.length;a++)c[a].status=2,h=h.concat(cP(f.serverSyncTree_,c[a].currentWriteId)),c[a].onComplete&&i.push(()=>c[a].onComplete(null,!0,c[a].currentOutputSnapshotResolved)),c[a].unwatcher();d1(f,dg(f.transactionQueueTree_,b)),dW(f,f.transactionQueueTree_),dG(f.eventQueue_,b,h);for(let j=0;j<i.length;j++)au(i[j])}else{if("datastale"===d)for(let e=0;e<c.length;e++)3===c[e].status?c[e].status=4:c[e].status=0;else{ai("transaction at "+m.toString()+" failed: "+d);for(let g=0;g<c.length;g++)c[g].status=4,c[g].abortReason=d}dY(f,b)}},i)}function dY(a,d){let b=d$(a,d),c=dm(b),e=d_(a,b);return dZ(a,e,c),c}function dZ(b,d,o){if(0===d.length)return;let g=[],c=[],r=d.filter(a=>0===a.status),m=r.map(a=>a.currentWriteId);for(let e=0;e<d.length;e++){let a=d[e],s=aZ(o,a.path),h=!1,i;if((0,l.hu)(null!==s,"rerunTransactionsUnderNode_: relativePath should not be null."),4===a.status)h=!0,i=a.abortReason,c=c.concat(cP(b.serverSyncTree_,a.currentWriteId,!0));else if(0===a.status){if(a.retryCount>=25)h=!0,i="maxretry",c=c.concat(cP(b.serverSyncTree_,a.currentWriteId,!0));else{let j=dV(b,a.path,m);a.currentInputSnapshot=j;let f=d[e].update(j.val());if(void 0!==f){dw("transaction failed: Data returned ",f,a.path);let k=Q(f),t="object"==typeof f&&null!=f&&(0,l.r3)(f,".priority");t||(k=k.updatePriority(j.getPriority()));let p=a.currentWriteId,u=dL(b),q=dd(k,j,u);a.currentOutputSnapshotRaw=k,a.currentOutputSnapshotResolved=q,a.currentWriteId=dP(b),m.splice(m.indexOf(p),1),c=(c=c.concat(cO(b.serverSyncTree_,a.path,q,a.currentWriteId,a.applyLocally))).concat(cP(b.serverSyncTree_,p,!0))}else h=!0,i="nodata",c=c.concat(cP(b.serverSyncTree_,a.currentWriteId,!0))}}if(dG(b.eventQueue_,o,c),c=[],h){var v;d[e].status=2,setTimeout(v=d[e].unwatcher,Math.floor(0)),d[e].onComplete&&("nodata"===i?g.push(()=>d[e].onComplete(null,!1,d[e].currentInputSnapshot)):g.push(()=>d[e].onComplete(Error(i),!1,null)))}}d1(b,b.transactionQueueTree_);for(let n=0;n<g.length;n++)au(g[n]);dW(b,b.transactionQueueTree_)}function d$(d,a){let b,c=d.transactionQueueTree_;for(b=aR(a);null!==b&&void 0===dh(c);)c=dg(c,b),a=aT(a),b=aR(a);return c}function d_(b,c){let a=[];return d0(b,c,a),a.sort((a,b)=>a.order-b.order),a}function d0(e,c,d){let a=dh(c);if(a)for(let b=0;b<a.length;b++)d.push(a[b]);dk(c,a=>{d0(e,a,d)})}function d1(e,c){let a=dh(c);if(a){let d=0;for(let b=0;b<a.length;b++)2!==a[b].status&&(a[d]=a[b],d++);a.length=d,di(c,a.length>0?a:void 0)}dk(c,a=>{d1(e,a)})}function d2(a,c){let d=dm(d$(a,c)),b=dg(a.transactionQueueTree_,c);return!function(b,c,d){let a=b.parent;for(;null!==a;){if(c(a))return!0;a=a.parent}return!1}(b,b=>{d3(a,b)}),d3(a,b),dl(b,b=>{d3(a,b)}),d}function d3(h,d){let b=dh(d);if(b){let e=[],f=[],c=-1;for(let a=0;a<b.length;a++)3===b[a].status||(1===b[a].status?((0,l.hu)(c===a-1,"All SENT items should be at beginning of queue."),c=a,b[a].status=3,b[a].abortReason="set"):((0,l.hu)(0===b[a].status,"Unexpected transaction status in abort"),b[a].unwatcher(),f=f.concat(cP(h.serverSyncTree_,b[a].currentWriteId,!0)),b[a].onComplete&&e.push(b[a].onComplete.bind(null,Error("set"),!1,null))));-1===c?di(d,void 0):b.length=c+1,dG(h.eventQueue_,dm(d),f);for(let g=0;g<e.length;g++)au(e[g])}}let d4=function(c,d){let a=d5(c),b=a.namespace;"firebase.com"===a.domain&&ah(a.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),b&&"undefined"!==b||"localhost"===a.domain||ah("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),a.secure||aj();let e="ws"===a.scheme||"wss"===a.scheme;return{repoInfo:new aC(a.host,a.secure,b,e,d,"",b!==a.subdomain),path:new aP(a.pathString)}},d5=function(a){let b="",f="",h="",k="",i="",l=!0,g="https",m=443;if("string"==typeof a){let c=a.indexOf("//");c>=0&&(g=a.substring(0,c-1),a=a.substring(c+2));let e=a.indexOf("/");-1===e&&(e=a.length);let d=a.indexOf("?");-1===d&&(d=a.length),b=a.substring(0,Math.min(e,d)),e<d&&(k=function(e){let d="",b=e.split("/");for(let a=0;a<b.length;a++)if(b[a].length>0){let c=b[a];try{c=decodeURIComponent(c.replace(/\+/g," "))}catch(f){}d+="/"+c}return d}(a.substring(e,d)));let n=function(a){let d={};for(let b of("?"===a.charAt(0)&&(a=a.substring(1)),a.split("&"))){if(0===b.length)continue;let c=b.split("=");2===c.length?d[decodeURIComponent(c[0])]=decodeURIComponent(c[1]):ai(`Invalid query segment '${b}' in query '${a}'`)}return d}(a.substring(Math.min(a.length,d)));(c=b.indexOf(":"))>=0?(l="https"===g||"wss"===g,m=parseInt(b.substring(c+1),10)):c=b.length;let j=b.slice(0,c);if("localhost"===j.toLowerCase())f="localhost";else if(j.split(".").length<=2)f=j;else{let o=b.indexOf(".");h=b.substring(0,o).toLowerCase(),f=b.substring(o+1),i=h}"ns"in n&&(i=n.ns)}return{host:b,port:m,domain:f,subdomain:h,secure:l,scheme:g,pathString:k,namespace:i}};class d6{constructor(a,b,c,d){this.eventType=a,this.eventRegistration=b,this.snapshot=c,this.prevName=d}getPath(){let a=this.snapshot.ref;return"value"===this.eventType?a._path:a.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+(0,l.Pz)(this.snapshot.exportVal())}}class d7{constructor(a,b,c){this.eventRegistration=a,this.error=b,this.path=c}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}
class d8{constructor(a,b){this.snapshotCallback=a,this.cancelCallback=b}onValue(a,b){this.snapshotCallback.call(null,a,b)}onCancel(a){return(0,l.hu)(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,a)}get hasCancelCallback(){return!!this.cancelCallback}matches(a){return this.snapshotCallback===a.snapshotCallback||void 0!==this.snapshotCallback.userCallback&&this.snapshotCallback.userCallback===a.snapshotCallback.userCallback&&this.snapshotCallback.context===a.snapshotCallback.context}}
class R{constructor(a,b,c,d){this._repo=a,this._path=b,this._queryParams=c,this._orderByCalled=d}get key(){return aY(this._path)?null:aU(this._path)}get ref(){return new z(this._repo,this._path)}get _queryIdentifier(){let b=bC(this._queryParams),a=ao(b);return"{}"===a?"default":a}get _queryObject(){return bC(this._queryParams)}isEqual(a){if(!((a=(0,l.m9)(a))instanceof R))return!1;let b=this._repo===a._repo,c=a_(this._path,a._path),d=this._queryIdentifier===a._queryIdentifier;return b&&c&&d}toJSON(){return this.toString()}toString(){return this._repo.toString()+function(a){let c="";for(let b=a.pieceNum_;b<a.pieces_.length;b++)""!==a.pieces_[b]&&(c+="/"+encodeURIComponent(String(a.pieces_[b])));return c||"/"}(this._path)}}function d9(a,b){if(!0===a._orderByCalled)throw Error(b+": You can't combine multiple orderBy calls.")}function ea(a){let b=null,c=null;if(a.hasStart()&&(b=a.getIndexStartValue()),a.hasEnd()&&(c=a.getIndexEndValue()),a.getIndex()===a6){let d="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",e="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(a.hasStart()){let f=a.getIndexStartName();if(f!==I)throw Error(d);if("string"!=typeof b)throw Error(e)}if(a.hasEnd()){let g=a.getIndexEndName();if(g!==J)throw Error(d);if("string"!=typeof c)throw Error(e)}}else if(a.getIndex()===bd){if(null!=b&&!du(b)||null!=c&&!du(c))throw Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if((0,l.hu)(a.getIndex()instanceof bl||a.getIndex()===bm,"unknown index type."),null!=b&&"object"==typeof b||null!=c&&"object"==typeof c)throw Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function eb(a){if(a.hasStart()&&a.hasEnd()&&a.hasLimit()&&!a.hasAnchoredLimit())throw Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}class z extends R{constructor(a,b){super(a,b,new bx,!1)}get parent(){let a=aW(this._path);return null===a?null:new z(this._repo,a)}get root(){let a=this;for(;null!==a.parent;)a=a.parent;return a}}class ec{constructor(a,b,c){this._node=a,this.ref=b,this._index=c}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(a){let b=new aP(a),c=ee(this.ref,a);return new ec(this._node.getChild(b),c,bd)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(b){if(this._node.isLeafNode())return!1;let a=this._node;return!!a.forEachChild(this._index,(a,c)=>b(new ec(c,ee(this.ref,a),bd)))}hasChild(a){let b=new aP(a);return!this._node.getChild(b).isEmpty()}hasChildren(){return!this._node.isLeafNode()&&!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function ed(a,b){return(a=(0,l.m9)(a))._checkNotDeleted("ref"),void 0!==b?ee(a._root,b):a._root}function ee(a,b){return null===aR((a=(0,l.m9)(a))._path)?dB("child","path",b,!1):dA("child","path",b,!1),new z(a._repo,aX(a._path,b))}function ef(a,c){a=(0,l.m9)(a),dC("push",a._path),dv("push",c,a._path,!0);let g=dK(a._repo),e=bo(g),d=ee(a,e),f=ee(a,e),b;return b=null!=c?eg(f,c).then(()=>f):Promise.resolve(f),d.then=b.then.bind(b),d.catch=b.then.bind(b,void 0),d}function eg(a,b){dC("set",(a=(0,l.m9)(a))._path),dv("set",b,a._path,!1);let c=new l.BH;return function l(a,b,c,d,m){dT(a,"set",{path:b.toString(),value:c,priority:d});let g=dL(a),e=Q(c,d),h=cU(a.serverSyncTree_,b),i=dd(e,h,g),j=dP(a),k=cO(a.serverSyncTree_,b,i,j,!0);dE(a.eventQueue_,k),a.server_.put(b.toString(),e.val(!0),(c,e)=>{let d="ok"===c;d||ai("set at "+b+" failed: "+c);let f=cP(a.serverSyncTree_,j,!d);dG(a.eventQueue_,b,f),dU(a,m,c,e)});let f=d2(a,b);dY(a,f),dG(a.eventQueue_,f,[])}(a._repo,a._path,b,null,c.wrapCallback(()=>{})),c.promise}function eh(a){a=(0,l.m9)(a);let b=new d8(()=>{}),c=new ei(b);return(function(a,b,d){let c=function(a,d){var h;let f=d._path,c=null;a.syncPointTree_.foreachOnPath(f,(a,b)=>{let d=aZ(a,f);c=c||cH(b,d)});let b=a.syncPointTree_.get(f);b?c=c||cH(b,aQ()):(b=new cD,a.syncPointTree_=a.syncPointTree_.set(f,b));let g=null!=c,i=g?new bS(c,!0,!1):null,j=cc(a.pendingWriteTree_,d._path),k=cF(b,d,j,g?i.getNode():e.EMPTY_NODE,g);return bZ((h=k).viewCache_)}(a.serverSyncTree_,b);return null!=c?Promise.resolve(c):a.server_.get(b).then(f=>{let c=Q(f).withIndex(b._queryParams.getIndex());cT(a.serverSyncTree_,b,d,!0);let e;if(b._queryParams.loadsAllData())e=cQ(a.serverSyncTree_,b._path,c);else{let g=cZ(a.serverSyncTree_,b);e=cS(a.serverSyncTree_,b._path,c,g)}return dG(a.eventQueue_,b._path,e),cR(a.serverSyncTree_,b,d,null,!0),c},c=>(dT(a,"get for query "+(0,l.Pz)(b)+" failed: "+c),Promise.reject(Error(c))))})(a._repo,a,c).then(b=>new ec(b,new z(a._repo,a._path),a._queryParams.getIndex()))}class ei{constructor(a){this.callbackContext=a}respondsTo(a){return"value"===a}createEvent(b,a){let c=a._queryParams.getIndex();return new d6("value",this,new ec(b.snapshotNode,new z(a._repo,a._path),c))}getEventRunner(a){return"cancel"===a.getEventType()?()=>this.callbackContext.onCancel(a.error):()=>this.callbackContext.onValue(a.snapshot,null)}createCancelEvent(a,b){return this.callbackContext.hasCancelCallback?new d7(this,a,b):null}matches(a){return a instanceof ei&&(!a.callbackContext||!this.callbackContext||a.callbackContext.matches(this.callbackContext))}hasAnyCallback(){return null!==this.callbackContext}}class ej{constructor(a,b){this.eventType=a,this.callbackContext=b}respondsTo(b){let a="children_added"===b?"child_added":b;return a="children_removed"===a?"child_removed":a,this.eventType===a}createCancelEvent(a,b){return this.callbackContext.hasCancelCallback?new d7(this,a,b):null}createEvent(a,b){assert(null!=a.childName,"Child events should have a childName.");let c=ee(new z(b._repo,b._path),a.childName),d=b._queryParams.getIndex();return new d6(a.type,this,new ec(a.snapshotNode,c,d),a.prevName)}getEventRunner(a){return"cancel"===a.getEventType()?()=>this.callbackContext.onCancel(a.error):()=>this.callbackContext.onValue(a.snapshot,a.prevName)}matches(a){return a instanceof ej&&this.eventType===a.eventType&&(!this.callbackContext||!a.callbackContext||this.callbackContext.matches(a.callbackContext))}hasAnyCallback(){return!!this.callbackContext}}class S{}class ek extends null{constructor(a,b){super(),this._value=a,this._key=b}_apply(a){dv("endAt",this._value,a._path,!0);let b=bz(a._queryParams,this._value,this._key);if(eb(b),ea(b),a._queryParams.hasEnd())throw Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new R(a._repo,a._path,b,a._orderByCalled)}}class el extends null{constructor(a,b){super(),this._value=a,this._key=b}_apply(a){dv("startAt",this._value,a._path,!0);let b=by(a._queryParams,this._value,this._key);if(eb(b),ea(b),a._queryParams.hasStart())throw Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new R(a._repo,a._path,b,a._orderByCalled)}}class em extends S{_apply(a){d9(a,"orderByKey");let b=bA(a._queryParams,a6);return ea(b),new R(a._repo,a._path,b,!0)}}function en(){return new em}function eo(b,...c){let a=(0,l.m9)(b);for(let d of c)a=d._apply(a);return a}i=z,(0,l.hu)(!x,"__referenceConstructor has already been defined"),x=i,j=z,(0,l.hu)(!y,"__referenceConstructor has already been defined"),y=j;let ep={},eq=!1;class er{constructor(a,b){this._repoInternal=a,this.app=b,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(function(a,c,b){if(a.stats_=aH(a.repoInfo_),a.forceRestClient_||av())a.server_=new bD(a.repoInfo_,(b,c,d,e)=>{dM(a,b,c,d,e)},a.authTokenProvider_,a.appCheckProvider_),setTimeout(()=>dN(a,!0),0);else{if(null!=b){if("object"!=typeof b)throw Error("Only objects are supported for option databaseAuthVariableOverride");try{(0,l.Pz)(b)}catch(e){throw Error("Invalid authOverride provided: "+e)}}a.persistentConnection_=new d(a.repoInfo_,c,(b,c,d,e)=>{dM(a,b,c,d,e)},b=>{dN(a,b)},c=>{var d,b;d=a,b=c,aq(b,(a,b)=>{dO(d,a,b)})},a.authTokenProvider_,a.appCheckProvider_,b),a.server_=a.persistentConnection_}a.authTokenProvider_.addTokenChangeListener(b=>{a.server_.refreshAuthToken(b)}),a.appCheckProvider_.addTokenChangeListener(b=>{a.server_.refreshAppCheckToken(b.token)}),a.statsReporter_=function(b,c){let a=b.toString();return aG[a]||(aG[a]=c()),aG[a]}(a.repoInfo_,()=>new bK(a.stats_,a.server_)),a.infoData_=new bE,a.infoSyncTree_=new cN({startListening(b,e,f,g){let c=[],d=a.infoData_.getNode(b._path);return d.isEmpty()||(c=cQ(a.infoSyncTree_,b._path,d),setTimeout(()=>{g("ok")},0)),c},stopListening(){}}),dO(a,"connected",!1),a.serverSyncTree_=new cN({startListening:(b,c,d,e)=>(a.server_.listen(b,d,c,(c,d)=>{let f=e(c,d);dG(a.eventQueue_,b._path,f)}),[]),stopListening(b,c){a.server_.unlisten(b,c)}})}(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new z(this._repo,aQ())),this._rootInternal}_delete(){return null!==this._rootInternal&&(function(a,c){var d;let b=ep[c];b&&b[a.key]===a||ah(`Database ${c}(${a.repoInfo_}) has already been deleted.`),(d=a).persistentConnection_&&d.persistentConnection_.interrupt("repo_interrupt"),delete b[a.key]}(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(a){null===this._rootInternal&&ah("Cannot call "+a+" on a deleted database.")}}function es(a=(0,c.Mq)(),b){return(0,c.qX)(a,"database").getImmediate({identifier:b})}d.prototype.simpleListen=function(a,b){this.sendRequest("q",{p:a},b)},d.prototype.echo=function(a,b){this.sendRequest("echo",{d:a},b)},G=D=c.Jn,(0,c.Xd)(new E.wA("database",(a,{instanceIdentifier:b})=>{let c=a.getProvider("app").getImmediate(),d=a.getProvider("auth-internal"),e=a.getProvider("app-check-internal");return function(a,n,o,p,g){var e,h,l,m;let f=p||a.options.databaseURL;void 0===f&&(a.options.projectId||ah("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),ae("Using default host for project ",a.options.projectId),f=`${a.options.projectId}-default-rtdb.firebaseio.com`);let c=d4(f,g),i=c.repoInfo,j,k;void 0!==U&&U.env&&(k=U.env.FIREBASE_DATABASE_EMULATOR_HOST),k?(j=!0,i=(c=d4(f=`http://${k}?ns=${i.namespace}`,g)).repoInfo):j=!c.repoInfo.secure;let q=g&&j?new K(K.OWNER):new ay(a.name,a.options,n);dD("Invalid Firebase Database URL",c),aY(c.path)||ah("Database URL must point to the root of a Firebase Database (not including a child path).");let b,d,r=(e=i,h=a,l=q,m=new ax(a.name,o),b=ep[h.name],b||(b={},ep[h.name]=b),d=b[e.toURLString()],d&&ah("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),d=new dJ(e,eq,l,m),b[e.toURLString()]=d,d);return new er(r,a)}(c,d,e,b)},"PUBLIC").setMultipleInstances(!0)),(0,c.KN)(m,n,void 0),(0,c.KN)(m,n,"esm2017")}}])